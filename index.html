<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DezzBGram Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { height: 100dvh; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background-color: #f0f2f5; overflow: hidden; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Premium UI Elements */
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .glass-dark { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(24px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Animations */
        .modal-enter { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .toast-enter { animation: slideLeft 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { 0% { opacity: 0; transform: translateY(100%); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes slideLeft { 0% { opacity: 0; transform: translateX(100%); } 100% { opacity: 1; transform: translateX(0); } }
        
        /* Chat Bubbles */
        .chat-user { background: #ffffff; border: 1px solid #e5e7eb; border-bottom-left-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
        .chat-bot { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border-bottom-right-radius: 6px; box-shadow: 0 4px 12px rgba(37,99,235,0.25); }
        
        /* Sidebar Delete Button */
        .chat-item-wrap .delete-chat-btn { opacity: 0; transition: all 0.2s; transform: scale(0.9); }
        .chat-item-wrap:hover .delete-chat-btn { opacity: 1; transform: scale(1); }

        @media (max-width: 768px) {
            .chat-item-wrap .delete-chat-btn { opacity: 1; transform: scale(1); }
            .mobile-view-chat #sidebar { transform: translateX(-100%); }
            .mobile-view-chat #chat-area { transform: translateX(0); }
        }
    </style>
</head>
<body class="text-gray-800 antialiased flex w-full" id="main-body">

<div id="toast-container" class="fixed top-5 right-5 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

<div id="login-page" class="fixed inset-0 z-[99999] flex items-center justify-center p-4 bg-[conic-gradient(at_top_right,_var(--tw-gradient-stops))] from-slate-900 via-blue-900 to-slate-900 hidden">
    <div class="absolute top-[-10%] left-[-10%] w-72 h-72 bg-blue-500 rounded-full mix-blend-multiply filter blur-[100px] opacity-40"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-72 h-72 bg-indigo-500 rounded-full mix-blend-multiply filter blur-[100px] opacity-40"></div>

    <div class="glass-dark rounded-[30px] shadow-2xl w-full max-w-md p-8 relative overflow-hidden flex flex-col items-center">
        <div class="w-20 h-20 bg-gradient-to-br from-blue-400 to-blue-600 rounded-2xl flex items-center justify-center text-4xl text-white shadow-[0_0_20px_rgba(59,130,246,0.5)] mb-5">
            <i class="fa-solid fa-bolt"></i>
        </div>
        <h2 class="text-3xl font-black text-white tracking-wide mb-1">DezzBGram</h2>
        <p class="text-blue-300 text-sm font-medium mb-8 uppercase tracking-widest">Premium Workspace</p>

        <div id="saved-bots-container" class="w-full hidden mb-6">
            <p class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider text-left pl-1">Pilih Akun Tersimpan:</p>
            <div id="saved-bots-list" class="flex flex-col gap-2 max-h-44 overflow-y-auto hide-scroll p-1">
                </div>
            <div class="flex items-center gap-3 mt-5 mb-2">
                <div class="h-px bg-white/10 flex-1"></div>
                <span class="text-[10px] text-gray-500 font-bold uppercase">Tambah Akun Baru</span>
                <div class="h-px bg-white/10 flex-1"></div>
            </div>
        </div>

        <div class="w-full relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400">
                <i class="fa-solid fa-key"></i>
            </div>
            <input type="password" id="i-token-login" class="w-full pl-10 pr-4 py-4 bg-white/5 border border-white/10 rounded-2xl text-white placeholder-gray-400 focus:bg-white/10 focus:border-blue-400 outline-none transition font-mono text-sm shadow-inner" placeholder="Paste Token Bot di sini...">
        </div>
        
        <button id="btn-proses-login" onclick="prosesLoginUtama()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl mt-4 shadow-[0_0_15px_rgba(37,99,235,0.4)] transition-all active:scale-95 flex justify-center items-center gap-2">
            <span>Masuk Sistem</span> <i class="fa-solid fa-arrow-right-to-bracket"></i>
        </button>

        <button id="btn-cancel-login" onclick="batalLoginUtama()" class="w-full bg-white/5 hover:bg-white/10 text-gray-300 font-bold py-3.5 rounded-2xl mt-3 transition-all hidden">Kembali ke App</button>
    </div>
</div>

<div id="general-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[999] flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 modal-enter text-center" id="general-modal-content"></div>
</div>

<div id="msg-action-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[999] flex items-end md:items-center justify-center p-0 md:p-4 hidden" onclick="closeModal('msg-action-modal')">
    <div class="bg-white w-full md:w-[340px] rounded-t-[30px] md:rounded-3xl shadow-2xl slide-up md:modal-enter overflow-hidden flex flex-col max-h-[85vh]" onclick="event.stopPropagation()">
        <div class="w-full flex justify-center pt-3 md:hidden pb-1"><div class="w-12 h-1.5 bg-gray-300 rounded-full"></div></div>
        
        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50/80 flex justify-between items-center shrink-0">
            <div class="overflow-hidden pr-3 text-left">
                <h3 class="font-bold text-gray-900 text-[15px]">Tindakan Pesan</h3>
                <p id="action-msg-preview" class="text-xs text-gray-500 truncate mt-0.5">Preview...</p>
            </div>
            <button onclick="actionCopy()" class="text-blue-600 bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded-xl text-xs font-bold transition active:scale-95 shrink-0 flex items-center gap-1.5"><i class="fa-regular fa-copy"></i> Salin</button>
        </div>
        
        <div class="flex flex-col p-2.5 overflow-y-auto hide-scroll gap-1">
            <button onclick="actionReply()" class="flex items-center gap-3.5 p-3 hover:bg-gray-100 text-gray-800 rounded-2xl transition font-semibold text-[14px]"><div class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fa-solid fa-reply"></i></div> Balas Pesan</button>
            <button onclick="actionEdit()" id="btn-edit-msg" class="flex items-center gap-3.5 p-3 hover:bg-gray-100 text-gray-800 rounded-2xl transition font-semibold text-[14px]"><div class="w-8 h-8 rounded-full bg-yellow-50 text-yellow-500 flex items-center justify-center"><i class="fa-solid fa-pen"></i></div> Edit Pesan</button>
            <button onclick="actionForward()" class="flex items-center gap-3.5 p-3 hover:bg-gray-100 text-gray-800 rounded-2xl transition font-semibold text-[14px]"><div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center"><i class="fa-solid fa-share"></i></div> Teruskan...</button>
            <button onclick="actionRepeat()" class="flex items-center gap-3.5 p-3 hover:bg-gray-100 text-gray-800 rounded-2xl transition font-semibold text-[14px]"><div class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-500 flex items-center justify-center"><i class="fa-solid fa-rotate-right"></i></div> Kirim Ulang</button>
            <button onclick="actionPin()" class="flex items-center gap-3.5 p-3 hover:bg-gray-100 text-gray-800 rounded-2xl transition font-semibold text-[14px]"><div class="w-8 h-8 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center"><i class="fa-solid fa-thumbtack"></i></div> Sematkan (Pin)</button>
            <div class="h-px bg-gray-200 my-1 mx-3"></div>
            <button onclick="actionDelete()" class="flex items-center gap-3.5 p-3 hover:bg-red-50 text-red-600 rounded-2xl transition font-bold text-[14px]"><div class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i class="fa-solid fa-trash-can"></i></div> Hapus Pesan</button>
        </div>
    </div>
</div>

<div class="flex w-full h-full relative hidden" id="app-container">

    <div class="w-full md:w-[76px] bg-[#0f172a] border-t md:border-t-0 md:border-r border-slate-800 flex md:flex-col items-center justify-around md:justify-start md:py-6 md:gap-4 absolute md:relative bottom-0 z-40 h-[60px] md:h-full shrink-0 px-2 md:px-0 overflow-x-auto hide-scroll">
        <button onclick="showTools('dezzbgram')" title="Info Web" class="w-[42px] h-[42px] rounded-[14px] bg-gradient-to-br from-blue-400 to-blue-600 text-white shadow-lg flex items-center justify-center transition hover:scale-105 shrink-0"><i class="fa-solid fa-bolt"></i></button>
        <button onclick="showTools('broadcast')" title="Broadcast" class="w-[42px] h-[42px] rounded-[14px] bg-white/10 text-gray-300 hover:bg-emerald-500 hover:text-white flex items-center justify-center transition shrink-0"><i class="fa-solid fa-bullhorn"></i></button>
        <button onclick="showTools('ttdl')" title="TikTok DL" class="w-[42px] h-[42px] rounded-[14px] bg-white/10 text-gray-300 hover:bg-pink-500 hover:text-white flex items-center justify-center transition shrink-0"><i class="fa-brands fa-tiktok"></i></button>
        <button onclick="showTools('device')" title="Device Info" class="w-[42px] h-[42px] rounded-[14px] bg-white/10 text-gray-300 hover:bg-indigo-500 hover:text-white flex items-center justify-center transition shrink-0"><i class="fa-solid fa-mobile-screen"></i></button>
        <button onclick="bukaHalamanLogin(true)" title="Ganti/Tambah Bot" class="w-[42px] h-[42px] rounded-[14px] bg-blue-500/20 text-blue-400 hover:bg-blue-600 hover:text-white flex items-center justify-center transition shrink-0"><i class="fa-solid fa-plus"></i></button>
        
        <div class="hidden md:block w-8 h-px bg-white/20 my-1"></div><div class="md:hidden h-6 w-px bg-white/20 mx-1"></div>
        <div id="bot-list-container" class="flex md:flex-col gap-3 shrink-0 items-center"></div>
    </div>

    <div id="sidebar" class="w-full md:w-[340px] bg-white border-r border-gray-200 flex flex-col absolute md:relative z-20 h-[calc(100%-60px)] md:h-full shrink-0 transform translate-x-0 transition-transform duration-300">
        
        <div class="p-4 border-b border-gray-100 bg-white shadow-sm shrink-0 flex items-center justify-between z-10">
            <div class="flex items-center gap-3 overflow-hidden">
                <img id="active-bot-avatar" src="https://ui-avatars.com/api/?name=B" class="w-11 h-11 rounded-full object-cover border border-gray-200 shadow-sm shrink-0">
                <div class="overflow-hidden">
                    <h2 id="active-bot-name" class="font-extrabold text-gray-900 text-[15px] truncate leading-tight">DezzBGram</h2>
                    <p id="active-bot-username" class="text-[12px] text-blue-600 font-bold truncate">@Memuat...</p>
                </div>
            </div>
            <button onclick="confirmLogoutBot()" title="Logout Bot" class="w-9 h-9 rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition shrink-0 ml-2"><i class="fa-solid fa-power-off text-sm"></i></button>
        </div>
        
        <div class="px-3 pt-3 pb-1 bg-white">
            <div class="bg-gray-100/80 rounded-2xl px-3 py-2.5 flex items-center gap-2 text-gray-500 focus-within:ring-2 focus-within:ring-blue-100 focus-within:bg-blue-50 transition border border-transparent focus-within:border-blue-200">
                <i class="fa-solid fa-magnifying-glass text-xs"></i>
                <input type="text" placeholder="Cari obrolan..." class="bg-transparent border-none outline-none w-full text-[14px]" oninput="cariObrolan(this.value)">
            </div>
        </div>

        <div id="chat-list" class="flex-1 overflow-y-auto hide-scroll p-2 space-y-0.5 bg-white"></div>
    </div>

    <div id="chat-area" class="w-full absolute md:relative z-30 h-[calc(100%-60px)] md:h-full bg-[#f0f2f5] flex flex-col transform translate-x-full md:translate-x-0 transition-transform duration-300">
        
        <div class="h-[70px] border-b border-gray-200 flex items-center px-4 glass shrink-0 z-10 cursor-pointer" onclick="showTools('device')">
            <button onclick="event.stopPropagation(); closeMobileChat()" class="md:hidden mr-3 w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 active:scale-95 transition"><i class="fa-solid fa-arrow-left"></i></button>
            <img id="header-avatar" src="https://ui-avatars.com/api/?name=U" class="w-11 h-11 rounded-full object-cover mr-3 border-2 border-white shadow-sm bg-white">
            <div class="flex-1 overflow-hidden">
                <h3 id="header-name" class="font-bold text-gray-900 truncate text-[16px]">Pilih Obrolan</h3>
                <p id="header-sub" class="text-[12px] text-green-600 font-bold truncate">Sistem Aktif</p>
            </div>
        </div>

        <div id="messages-container" class="flex-1 overflow-y-auto hide-scroll p-4 md:p-6 space-y-4 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] relative"></div>

        <div class="bg-transparent shrink-0 z-10 flex flex-col p-3 md:p-4">
            <div class="bg-white rounded-[24px] shadow-[0_5px_20px_rgba(0,0,0,0.06)] border border-gray-200/60 overflow-hidden flex flex-col">
                
                <div class="flex items-center gap-1.5 px-4 py-2 bg-gray-50/50 border-b border-gray-100 overflow-x-auto hide-scroll">
                    <button onclick="formatText('b')" class="w-7 h-7 rounded-lg hover:bg-gray-200 font-bold text-gray-700 text-sm transition">B</button>
                    <button onclick="formatText('i')" class="w-7 h-7 rounded-lg hover:bg-gray-200 italic font-serif text-gray-700 text-sm transition">I</button>
                    <button onclick="formatText('s')" class="w-7 h-7 rounded-lg hover:bg-gray-200 line-through text-gray-700 text-sm transition">S</button>
                    <button onclick="formatText('code')" class="px-2.5 h-7 rounded-lg hover:bg-gray-200 font-mono text-gray-600 text-[11px] border border-gray-200 transition bg-white shadow-sm">Code</button>
                </div>

                <div id="action-indicator" class="hidden items-center justify-between bg-blue-50/50 border-l-[4px] border-blue-500 pl-3 pr-2 py-2 mx-2 mt-2 rounded-r-xl">
                    <div class="overflow-hidden flex flex-col justify-center">
                        <span id="action-label" class="text-[11px] font-extrabold text-blue-600 mb-0.5 leading-none">Aksi:</span>
                        <span id="action-text-ui" class="text-[13px] text-gray-700 truncate font-medium">...</span>
                    </div>
                    <button onclick="cancelAction()" class="w-7 h-7 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-500 flex justify-center items-center transition"><i class="fa-solid fa-xmark text-sm"></i></button>
                </div>
                
                <div class="flex items-end gap-2 p-2">
                    <button onclick="document.getElementById('fileUpload').click()" class="w-11 h-11 rounded-full text-gray-500 hover:bg-gray-100 flex items-center justify-center transition shrink-0 mb-0.5" title="Kirim File"><i class="fa-solid fa-paperclip text-[20px]"></i></button>
                    <input type="file" id="fileUpload" class="hidden" accept="image/*,audio/*,video/*,application/*" onchange="handleFileUpload()">
                    
                    <button onclick="showTools('poll')" class="w-11 h-11 rounded-full text-blue-500 hover:bg-blue-50 flex items-center justify-center transition shrink-0 mb-0.5" title="Buat Polling"><i class="fa-solid fa-chart-simple text-[18px]"></i></button>

                    <div class="flex-1 flex items-center px-1 py-1 transition duration-200">
                        <textarea id="msgInput" rows="1" placeholder="Ketik pesan..." class="w-full bg-transparent border-none focus:ring-0 py-2 outline-none text-[15px] resize-none hide-scroll" style="min-height: 40px; max-height: 120px;" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    </div>
                    
                    <button id="send-btn" onclick="kirimPesan()" class="w-[46px] h-[46px] rounded-full bg-blue-600 text-white hover:bg-blue-700 flex items-center justify-center shadow-lg shadow-blue-600/30 active:scale-90 shrink-0 transition mb-0.5 mr-1"><i class="fa-solid fa-paper-plane text-[18px] ml-1"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. UTILITIES ---
    const safeEncode = (str) => { try { return btoa(encodeURIComponent(str || '')); } catch(e){ return ''; } };
    const safeDecode = (str) => { try { return decodeURIComponent(atob(str)); } catch(e){ return ''; } };

    function showToast(msg, type = 'success') {
        const c = document.getElementById('toast-container'); const t = document.createElement('div');
        t.className = `${type==='success'?'bg-emerald-600':'bg-red-600'} text-white px-4 py-3 rounded-2xl shadow-2xl flex items-center gap-3 toast-enter border border-white/10`;
        t.innerHTML = `<i class="fa-solid ${type==='success'?'fa-check text-white':'fa-triangle-exclamation text-white'} text-lg"></i><span class="text-[13px] font-bold tracking-wide">${msg}</span>`;
        c.appendChild(t); setTimeout(() => { t.style.opacity='0'; t.style.transform='translateX(100%)'; t.style.transition='all 0.3s'; setTimeout(()=>t.remove(),300); }, 2500);
    }
    
    function openModalGen(htmlContent) { document.getElementById('general-modal-content').innerHTML = htmlContent; document.getElementById('general-modal').classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function closeGenModal() { closeModal('general-modal'); }

    // --- 2. STATE MANAGEMENT ---
    let bots = []; 
    let activeToken = '';
    let chatsData = {}; let activeChatId = null; let pollingInterval = null;
    let selectedMsgId = null; let selectedMsgText = ""; let selectedMsgType = "text"; let selectedMsgSender = "";
    let replyToMsgId = null; let editMsgId = null;

    // --- 3. AUTO LOGIN / BOOT CHECK ---
    window.onload = () => {
        try {
            let localBots = localStorage.getItem('dz_bots_v14');
            bots = localBots ? JSON.parse(localBots) : [];
            activeToken = localStorage.getItem('dz_active_v14') || '';
        } catch(e) { bots = []; activeToken = ''; }

        if (bots.length === 0 || !activeToken) {
            bukaHalamanLogin(false);
        } else {
            initApp();
        }
    };

    // Fungsi Utama Buka Halaman Login Premium
    function bukaHalamanLogin(fromApp = false) {
        document.getElementById('app-container').classList.add('hidden');
        document.getElementById('login-page').classList.remove('hidden');
        
        if (fromApp && bots.length > 0) {
            document.getElementById('btn-cancel-login').classList.remove('hidden');
        } else {
            document.getElementById('btn-cancel-login').classList.add('hidden');
        }

        // Render List Bot Tersimpan di Halaman Login
        let listContainer = document.getElementById('saved-bots-list');
        let wrapContainer = document.getElementById('saved-bots-container');
        
        if(bots.length > 0) {
            wrapContainer.classList.remove('hidden');
            listContainer.innerHTML = '';
            bots.forEach(b => {
                listContainer.innerHTML += `
                    <div onclick="masukAkunTersimpan('${b.token}')" class="flex items-center p-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl cursor-pointer transition w-full">
                        <img src="${b.avatar}" class="w-11 h-11 rounded-full mr-3 border border-white/20">
                        <div class="flex-1 overflow-hidden text-left">
                            <h4 class="text-[14px] font-bold text-white truncate">${b.name}</h4>
                            <p class="text-xs text-blue-400 font-medium truncate">@${b.username}</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-white/50 text-sm mr-2"></i>
                    </div>`;
            });
        } else {
            wrapContainer.classList.add('hidden');
        }
    }

    function batalLoginUtama() {
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
    }

    function masukAkunTersimpan(token) {
        localStorage.setItem('dz_active_v14', token);
        location.reload();
    }

    async function prosesLoginUtama() {
        let token = document.getElementById('i-token-login').value.trim(); 
        if(!token) return showToast('Token wajib diisi!', 'error');
        
        let btn = document.getElementById('btn-proses-login');
        btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Memverifikasi...`;
        
        try {
            let res = await fetch(`https://api.telegram.org/bot${token}/getMe`); let data = await res.json();
            if(data.ok) {
                if(!bots.find(b => b.token === token)) {
                    bots.push({ token, id: data.result.id, name: data.result.first_name, username: data.result.username, avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(data.result.first_name)}&background=3b82f6&color=fff`});
                    localStorage.setItem('dz_bots_v14', JSON.stringify(bots)); 
                }
                localStorage.setItem('dz_active_v14', token); 
                location.reload(); 
            } else {
                showToast('Token Telegram Invalid!', 'error');
                btn.innerHTML = `<span>Masuk Sistem</span> <i class="fa-solid fa-arrow-right-to-bracket"></i>`;
            }
        } catch(e) { 
            showToast('Gagal terhubung ke server', 'error'); 
            btn.innerHTML = `<span>Masuk Sistem</span> <i class="fa-solid fa-arrow-right-to-bracket"></i>`;
        }
    }

    async function tgApi(method, payload = {}, isFormData = false) {
        let opt = { method: 'POST' };
        if (isFormData) opt.body = payload; else { opt.headers = {'Content-Type': 'application/json'}; opt.body = JSON.stringify(payload); }
        try { let res = await fetch(`https://api.telegram.org/bot${activeToken}/${method}`, opt); return await res.json(); } 
        catch (e) { return {ok: false}; }
    }

    // --- 4. APP INIT ---
    function initApp() {
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('general-modal').classList.add('hidden');
        let bot = bots.find(b => b.token === activeToken);
        if(!bot) { bukaHalamanLogin(false); return; } 
        
        document.getElementById('app-container').classList.remove('hidden');
        
        document.getElementById('active-bot-name').innerText = bot.name;
        document.getElementById('active-bot-username').innerText = `@${bot.username}`;
        document.getElementById('active-bot-avatar').src = bot.avatar;
        
        try { let localChats = localStorage.getItem(`dz_chats_v14_${bot.id}`); chatsData = localChats ? JSON.parse(localChats) : {}; } 
        catch(e) { chatsData = {}; }

        renderNavRail(); renderSidebar(); startPolling();
    }

    function renderNavRail() {
        let c = document.getElementById('bot-list-container'); c.innerHTML = '';
        bots.forEach(b => {
            let active = b.token === activeToken ? 'border-2 border-white shadow-[0_0_15px_rgba(255,255,255,0.4)] scale-110' : 'opacity-50 hover:opacity-100 hover:scale-105';
            c.innerHTML += `<img src="${b.avatar}" title="${b.name}" onclick="masukAkunTersimpan('${b.token}')" class="w-[42px] h-[42px] rounded-[14px] object-cover cursor-pointer transition-all duration-300 ${active}">`;
        });
    }

    function confirmLogoutBot() {
        if(confirm('Hapus bot ini dari Workspace DezzBGram?')) {
            bots = bots.filter(b => b.token !== activeToken); localStorage.setItem('dz_bots_v14', JSON.stringify(bots));
            if(bots.length > 0) localStorage.setItem('dz_active_v14', bots[0].token);
            else { localStorage.removeItem('dz_active_v14'); localStorage.removeItem('dz_bots_v14'); }
            location.reload();
        }
    }

    // --- 5. TOOL MODALS (INSIDE APP) ---
    function showTools(type) {
        let html = '';
        if(type === 'device') {
            html = `<h2 class="text-2xl font-black mb-4 text-gray-900">ðŸ“± Info Device</h2>
                    <div class="text-left bg-gray-50 p-4 rounded-2xl text-[14px] space-y-2 border border-gray-200">
                    <p><b class="text-gray-900">OS:</b> <span class="text-gray-600">${navigator.platform}</span></p>
                    <p><b class="text-gray-900">Browser:</b> <span class="text-gray-600">${navigator.userAgent.split(' ')[0]}</span></p>
                    <p><b class="text-gray-900">Resolusi:</b> <span class="text-gray-600">${window.innerWidth} x ${window.innerHeight} px</span></p></div>
                    <button onclick="closeGenModal()" class="w-full mt-4 bg-red-50 text-red-600 py-3.5 rounded-2xl font-bold hover:bg-red-100 transition">Tutup</button>`;
        } else if(type === 'ttdl') {
            html = `<h2 class="text-2xl font-black mb-2 text-gray-900"><i class="fa-brands fa-tiktok"></i> TikTok DL</h2>
                    <p class="text-[13px] text-gray-500 font-medium mb-5">Video dikirim otomatis tanpa watermark</p>
                    <input type="text" id="i-tt" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl mb-4 text-sm outline-none focus:ring-2 focus:ring-pink-500 transition" placeholder="Paste Link TikTok...">
                    <button onclick="prosesTTDL()" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-2xl mb-2 shadow-xl hover:bg-black transition">Download Video</button>
                    <button onclick="closeGenModal()" class="w-full bg-gray-100 py-3.5 rounded-2xl font-bold text-gray-700 hover:bg-gray-200 transition">Batal</button>`;
        } else if(type === 'broadcast') {
            html = `<h2 class="text-2xl font-black mb-4 text-gray-900">ðŸ“¢ Broadcast Pesan</h2>
                    <textarea id="i-bc" rows="4" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl mb-4 text-[14px] outline-none focus:ring-2 focus:ring-emerald-500 transition resize-none hide-scroll" placeholder="Ketik pesan massal di sini... (Mendukung HTML)"></textarea>
                    <button onclick="prosesBC()" class="w-full bg-emerald-600 text-white font-bold py-3.5 rounded-2xl mb-2 shadow-lg shadow-emerald-500/30 hover:bg-emerald-700 transition">Kirim ke Semua (${Object.keys(chatsData).length} chat)</button>
                    <button onclick="closeGenModal()" class="w-full bg-gray-100 py-3.5 rounded-2xl font-bold text-gray-700 hover:bg-gray-200 transition">Batal</button>`;
        } else if(type === 'dezzbgram') {
            html = `<div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-4 text-5xl shadow-2xl"><i class="fa-solid fa-bolt"></i></div>
                    <h2 class="text-3xl font-black text-gray-900 mb-1">DezzBGram</h2>
                    <p class="text-[13px] font-extrabold text-blue-600 bg-blue-50 inline-block px-4 py-1.5 rounded-full mb-5">Versi 14.0 Ultimate Final</p>
                    <button onclick="window.location.href='dev.html'" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-2xl mb-2 hover:bg-black transition flex justify-center items-center gap-2 shadow-xl"><i class="fa-solid fa-code"></i> Ke Halaman Developer</button>
                    <button onclick="closeGenModal()" class="w-full bg-gray-100 py-3.5 rounded-2xl font-bold text-gray-700 hover:bg-gray-200 transition">Tutup</button>`;
        } else if(type === 'forward') {
            let listHTML = Object.values(chatsData).map(c => `<div onclick="executeForward('${c.id}', true)" class="flex items-center p-3 hover:bg-gray-50 rounded-xl cursor-pointer transition"><img src="${c.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(c.name)}`}" class="w-10 h-10 rounded-full mr-3 border border-gray-100"><span class="text-[14px] font-bold text-gray-800 truncate">${c.name}</span></div>`).join('');
            html = `<h2 class="text-xl font-black mb-4 text-left text-gray-900">Teruskan ke...</h2>
                    <div class="flex gap-2 mb-4 bg-gray-100 p-1.5 rounded-2xl">
                        <button onclick="setFwdMode(false)" id="btn-fwd-ori" class="flex-1 bg-white shadow-sm text-gray-900 py-2.5 rounded-xl text-xs font-bold transition">Asli (Ori)</button>
                        <button onclick="setFwdMode(true)" id="btn-fwd-copy" class="flex-1 text-gray-500 py-2.5 rounded-xl text-xs font-bold transition">No Sender</button>
                    </div>
                    <div class="max-h-56 overflow-y-auto border border-gray-200 p-2 rounded-2xl mb-4 hide-scroll bg-gray-50/50">${listHTML}</div>
                    <button onclick="closeGenModal()" class="w-full bg-gray-100 py-3.5 rounded-2xl font-bold text-gray-700 hover:bg-gray-200 transition">Batal</button>`;
        } else if(type === 'poll') {
            html = `<h2 class="text-xl font-black mb-4 text-left text-gray-900"><i class="fa-solid fa-chart-simple text-blue-500 mr-2"></i> Buat Polling</h2>
                    <input type="text" id="poll-q" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl mb-3 text-[14px] font-bold outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Pertanyaan Anda...">
                    <input type="text" id="poll-o1" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-2xl mb-2 text-sm outline-none focus:border-blue-500 transition" placeholder="Opsi 1...">
                    <input type="text" id="poll-o2" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-2xl mb-2 text-sm outline-none focus:border-blue-500 transition" placeholder="Opsi 2...">
                    <input type="text" id="poll-o3" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-2xl mb-4 text-sm outline-none focus:border-blue-500 transition" placeholder="Opsi 3 (Opsional)...">
                    <button onclick="kirimPoll()" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-2xl mb-2 shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">Kirim Polling</button>
                    <button onclick="closeGenModal()" class="w-full bg-gray-100 py-3.5 rounded-2xl font-bold text-gray-700 hover:bg-gray-200 transition">Batal</button>`;
        }
        openModalGen(html);
    }

    async function prosesTTDL() {
        if(!activeChatId) return showToast('Buka chat dulu bang!', 'error');
        let url = document.getElementById('i-tt').value; if(!url.includes('tiktok.com')) return showToast('Link salah', 'error');
        showToast('Download dimulai...'); closeGenModal();
        try {
            let r = await fetch(`https://tikwm.com/api/?url=${url}`); let d = await r.json();
            if(d.code===0 && d.data.play) {
                let s = await tgApi('sendVideo', {chat_id: activeChatId, video: d.data.play, caption: `ðŸ“¥ *TikTok Downloader*\n${d.data.title}`});
                if(s.ok) simpanPesan(activeChatId, chatsData[activeChatId].name, d.data.title, 'bot', s.result.message_id, 'video', d.data.play);
            } else showToast('Gagal narik video TikTok', 'error');
        } catch(e) { showToast('Error API TikTok', 'error'); }
    }

    async function prosesBC() {
        let txt = document.getElementById('i-bc').value; if(!txt) return; closeGenModal();
        let cIds = Object.keys(chatsData); let c = 0; showToast('Proses Broadcast...', 'success');
        for(let id of cIds) {
            let r = await tgApi('sendMessage', {chat_id: id, text: `[BROADCAST]\n\n${txt}`, parse_mode: 'HTML'});
            if(r.ok) { c++; simpanPesan(id, chatsData[id].name, `[BROADCAST]\n${txt}`, 'bot', r.result.message_id, 'text'); }
        }
        showToast(`Terkirim ke ${c} chat!`);
    }

    async function kirimPoll() {
        if(!activeChatId) return showToast('Pilih chat dulu!', 'error');
        let q = document.getElementById('poll-q').value.trim();
        let o1 = document.getElementById('poll-o1').value.trim(); let o2 = document.getElementById('poll-o2').value.trim();
        if(!q || !o1 || !o2) return showToast('Pertanyaan & 2 opsi wajib isi!', 'error');
        let opts = [o1, o2]; let o3 = document.getElementById('poll-o3').value.trim(); if(o3) opts.push(o3);
        
        closeGenModal();
        let res = await tgApi('sendPoll', {chat_id: activeChatId, question: q, options: JSON.stringify(opts)});
        if(res.ok) { simpanPesan(activeChatId, chatsData[activeChatId].name, `ðŸ“Š Polling: ${q}`, 'bot', res.result.message_id, 'poll'); }
    }

    let isCopyFwd = false;
    function setFwdMode(isCopy) {
        isCopyFwd = isCopy;
        document.getElementById('btn-fwd-copy').className = isCopy ? 'flex-1 bg-white shadow-sm text-gray-900 py-2.5 rounded-xl text-xs font-bold transition' : 'flex-1 text-gray-500 py-2.5 rounded-xl text-xs font-bold transition';
        document.getElementById('btn-fwd-ori').className = !isCopy ? 'flex-1 bg-white shadow-sm text-gray-900 py-2.5 rounded-xl text-xs font-bold transition' : 'flex-1 text-gray-500 py-2.5 rounded-xl text-xs font-bold transition';
    }
    async function executeForward(targetId) {
        closeGenModal(); let method = isCopyFwd ? 'copyMessage' : 'forwardMessage';
        let res = await tgApi(method, {chat_id: targetId, from_chat_id: activeChatId, message_id: selectedMsgId});
        if(res.ok) { showToast('Pesan Diteruskan!'); simpanPesan(targetId, chatsData[targetId].name, "[Pesan Diteruskan]", 'bot', res.result.message_id, 'text'); }
        else showToast('Gagal teruskan', 'error');
    }

    function cariObrolan(keyword) {
        let filter = keyword.toLowerCase(); let items = document.querySelectorAll('.chat-item-wrap');
        items.forEach(item => { let name = item.getAttribute('data-name').toLowerCase(); if(name.indexOf(filter) > -1) item.style.display = 'flex'; else item.style.display = 'none'; });
    }

    function formatText(tag) {
        let i = document.getElementById('msgInput'); let start = i.selectionStart; let end = i.selectionEnd;
        let text = i.value; let sel = text.substring(start, end) || "teks";
        let rep = `<${tag}>${sel}</${tag}>`; if(tag === 'code') rep = `<code>${sel}</code>`;
        i.value = text.substring(0, start) + rep + text.substring(end); i.focus();
    }

    // --- RENDER SIDEBAR ---
    function renderSidebar() {
        const list = document.getElementById('chat-list'); list.innerHTML = '';
        let arr = Object.values(chatsData).sort((a,b) => (b.messages[b.messages.length-1]?.timestamp||0) - (a.messages[a.messages.length-1]?.timestamp||0));
        
        arr.forEach(c => {
            let last = c.messages[c.messages.length - 1];
            let txt = last ? (last.type==='service'?'ðŸ“Œ Pesan disematkan':(last.type==='photo'?'ðŸ“· Gambar':(last.type==='video'?'ðŸŽ¥ Video':(last.type==='audio'?'ðŸŽµ Audio':(last.type==='sticker'?'ðŸŒŸ Stiker':(last.type==='poll'?'ðŸ“Š Polling':last.text))))))) : 'Mulai obrolan...';
            let act = activeChatId == c.id ? 'bg-blue-50/80 border-blue-500' : 'bg-white border-transparent hover:bg-gray-50';
            let badge = c.type !== 'private' ? `<span class="bg-indigo-100 text-indigo-700 px-1.5 py-[2px] rounded text-[9px] font-extrabold ml-1.5 tracking-wide">GRUP</span>` : '';
            let unread = c.unread > 0 ? `<div class="bg-blue-600 text-white text-[10px] font-bold h-5 w-5 rounded-full flex items-center justify-center shrink-0 ml-2 shadow-sm">${c.unread}</div>` : '';
            let safeName = c.name && c.name !== "undefined" ? c.name : "Pengguna";

            list.innerHTML += `
                <div class="chat-item-wrap flex items-center px-3 py-2.5 rounded-2xl cursor-pointer transition border-l-[3px] ${act}" data-name="${safeName}" onclick="openChat('${c.id}')">
                    <img src="${c.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(safeName)}`}" class="w-12 h-12 rounded-full object-cover mr-3.5 shrink-0 border border-gray-100">
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between items-center mb-0.5"><h4 class="font-bold text-gray-900 text-[14px] truncate">${safeName} ${badge}</h4>${unread}</div>
                        <p class="text-[12.5px] text-gray-500 truncate">${txt.replace(/<[^>]*>?/gm, '')}</p>
                    </div>
                    <button onclick="hapusObrolan('${c.id}', event)" class="delete-chat-btn w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition ml-2 shrink-0 z-10" title="Hapus Obrolan"><i class="fa-solid fa-trash-can text-xs"></i></button>
                </div>`;
        });
    }

    function hapusObrolan(chatId, e) {
        e.stopPropagation();
        if(confirm(`Yakin hapus chat ini dari daftar web?`)) {
            delete chatsData[chatId]; let botId = bots.find(b => b.token === activeToken).id;
            localStorage.setItem(`dz_chats_v14_${botId}`, JSON.stringify(chatsData));
            if(activeChatId === chatId) { closeMobileChat(); document.getElementById('messages-container').innerHTML = ''; }
            renderSidebar(); showToast('Chat dihapus.');
        }
    }

    function openChat(chatId) {
        activeChatId = chatId; chatsData[chatId].unread = 0;
        let botId = bots.find(b => b.token === activeToken).id; localStorage.setItem(`dz_chats_v14_${botId}`, JSON.stringify(chatsData));
        document.getElementById('main-body').classList.add('mobile-view-chat');
        
        let safeName = chatsData[chatId].name && chatsData[chatId].name !== "undefined" ? chatsData[chatId].name : "Pengguna";
        document.getElementById('header-name').innerText = safeName;
        document.getElementById('header-avatar').src = chatsData[chatId].avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(safeName)}`;
        document.getElementById('header-sub').innerText = chatsData[chatId].type !== 'private' ? 'Grup Obrolan' : 'Private Chat';
        renderMessages(); renderSidebar();
    }
    function closeMobileChat() { document.getElementById('main-body').classList.remove('mobile-view-chat'); activeChatId = null; renderSidebar(); }
    function formatTime(ts) { let d = new Date(ts); return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0'); }

    // --- SWIPE TO REPLY ---
    let swipeStartX = 0; let swipeTarget = null; let isSwiping = false;
    function ts(e, el) { swipeStartX = e.touches[0].clientX; swipeTarget = el; isSwiping = false; el.style.transition = 'none'; }
    function tm(e, el) { 
        if(!swipeStartX) return; let d = swipeStartX - e.touches[0].clientX; 
        if(d > 10) isSwiping = true; if(d > 0 && d < 60) el.style.transform = `translateX(-${d}px)`; 
    }
    function te(e, el, id, b64Text) {
        if(!swipeStartX) return; let d = swipeStartX - e.changedTouches[0].clientX;
        el.style.transition = 'transform 0.2s ease-out'; el.style.transform = `translateX(0)`;
        
        let txt = safeDecode(b64Text);
        if(d > 40 && isSwiping) { actionReplyManual(id, txt); } 
        else if (!isSwiping) {
            let msg = chatsData[activeChatId].messages.find(m => m.id === id);
            if(msg) showMsgAction(id, txt, msg.type, msg.sender);
        }
        swipeStartX = 0; swipeTarget = null; isSwiping = false;
    }

    // --- ACTION MODAL ---
    function showMsgAction(id, txt, type, sender) {
        selectedMsgId = id; selectedMsgText = txt; selectedMsgType = type; selectedMsgSender = sender;
        document.getElementById('action-msg-preview').innerText = txt ? txt.replace(/<[^>]*>?/gm, '').substring(0,40) + "..." : "Media / File Audio";
        document.getElementById('btn-edit-msg').style.display = sender === 'bot' && type === 'text' ? 'flex' : 'none'; 
        document.getElementById('msg-action-modal').classList.remove('hidden');
    }

    function setActionUI(label, txt) {
        document.getElementById('action-indicator').classList.replace('hidden', 'flex'); 
        document.getElementById('action-label').innerText = label;
        document.getElementById('action-text-ui').innerText = txt.replace(/<[^>]*>?/gm, '');
        document.getElementById('msgInput').focus();
    }
    
    function actionReplyManual(id, txt) { replyToMsgId = id; editMsgId = null; setActionUI("Membalas Pesan", txt||"Media"); }
    function actionReply() { closeModal('msg-action-modal'); actionReplyManual(selectedMsgId, selectedMsgText); }
    function actionEdit() { closeModal('msg-action-modal'); editMsgId = selectedMsgId; replyToMsgId = null; document.getElementById('msgInput').value = selectedMsgText; setActionUI("Edit Pesan", selectedMsgText); document.getElementById('send-btn').innerHTML = `<i class="fa-solid fa-check text-[18px]"></i>`; }
    function actionForward() { closeModal('msg-action-modal'); showTools('forward'); }
    function actionCopy() { closeModal('msg-action-modal'); navigator.clipboard.writeText(selectedMsgText); showToast('Teks disalin!'); }
    
    async function actionRepeat() {
        closeModal('msg-action-modal');
        let res = await tgApi('copyMessage', {chat_id: activeChatId, from_chat_id: activeChatId, message_id: selectedMsgId});
        if(res.ok) { simpanPesan(activeChatId, chatsData[activeChatId].name, selectedMsgText, 'bot', res.result.message_id, selectedMsgType, chatsData[activeChatId].messages.find(m=>m.id===selectedMsgId)?.mediaUrl); showToast('Pesan diulang!'); }
    }

    async function actionPin() {
        closeModal('msg-action-modal');
        let res = await tgApi('pinChatMessage', {chat_id: activeChatId, message_id: selectedMsgId});
        if(res.ok) {
            let botName = bots.find(b => b.token === activeToken).name;
            simpanPesan(activeChatId, chatsData[activeChatId].name, `ðŸ“Œ ${botName} menyematkan pesan '${selectedMsgText.replace(/<[^>]*>?/gm, '').substring(0,25)}...'`, 'bot', Date.now(), 'service');
            showToast('Pesan disematkan');
        }
    }

    async function actionDelete() {
        closeModal('msg-action-modal');
        await tgApi('deleteMessage', {chat_id: activeChatId, message_id: selectedMsgId});
        chatsData[activeChatId].messages = chatsData[activeChatId].messages.filter(m => m.id !== selectedMsgId);
        let botId = bots.find(b => b.token === activeToken).id; localStorage.setItem(`dz_chats_v14_${botId}`, JSON.stringify(chatsData)); 
        renderMessages(); renderSidebar(); showToast('Pesan dihapus');
    }

    function cancelAction() { replyToMsgId = null; editMsgId = null; document.getElementById('action-indicator').classList.replace('flex', 'hidden'); document.getElementById('msgInput').value=''; document.getElementById('msgInput').style.height=''; document.getElementById('send-btn').innerHTML = `<i class="fa-solid fa-paper-plane text-[18px] ml-1"></i>`;}

    // --- RENDER BUBBLE CHAT ---
    function renderMessages() {
        if (!activeChatId) return;
        const box = document.getElementById('messages-container'); box.innerHTML = '';
        let chat = chatsData[activeChatId];
        
        chat.messages.forEach(msg => {
            if (msg.type === 'service') { box.innerHTML += `<div class="flex justify-center my-3"><div class="bg-gray-400/20 text-gray-600 text-[11px] px-3.5 py-1.5 rounded-full font-semibold backdrop-blur-sm border border-gray-400/10 shadow-sm">${msg.text}</div></div>`; return; }

            let isUser = msg.sender === 'user';
            let alignCls = isUser ? 'items-start' : 'items-end';
            let bubCls = isUser ? 'chat-user' : 'chat-bot';
            
            let senderName = (chat.type !== 'private' && isUser && msg.realSender) ? `<div class="text-[11px] font-extrabold text-blue-500 mb-1.5 leading-none tracking-wide">${msg.realSender}</div>` : '';
            let replyHtml = msg.replyToText ? `<div class="bg-black/5 border-l-[3px] border-black/20 px-2 py-1.5 rounded mb-1.5 text-[11px] opacity-90 truncate max-w-full"><span class="font-bold text-blue-500 block mb-0.5">Membalas</span> ${msg.replyToText.replace(/<[^>]*>?/gm, '')}</div>` : '';
            
            let mediaHtml = '';
            if(msg.type === 'photo') mediaHtml = `<img src="${msg.mediaUrl}" class="rounded-xl mb-2 max-w-[240px] border border-black/5 shadow-sm">`;
            if(msg.type === 'video') mediaHtml = `<video src="${msg.mediaUrl}" controls class="rounded-xl mb-2 max-w-[240px] border border-black/5 shadow-sm"></video>`;
            if(msg.type === 'audio') mediaHtml = `<audio src="${msg.mediaUrl}" controls class="h-10 max-w-[240px] mb-1 outline-none"></audio>`;
            if(msg.type === 'sticker') mediaHtml = `<img src="${msg.mediaUrl}" class="w-32 h-32 mb-1 drop-shadow-lg">`; 

            let b64Text = safeEncode(msg.text); 
            let txtHtml = msg.text ? `<div class="text-[14.5px] leading-relaxed break-words whitespace-pre-wrap">${msg.text}</div>` : '';

            box.innerHTML += `
                <div class="flex flex-col ${alignCls} w-full mb-1.5 overflow-hidden">
                    <div class="max-w-[85%] px-3.5 py-2.5 rounded-2xl ${bubCls} cursor-pointer active:scale-[0.98] transition-transform shadow-sm" 
                         ontouchstart="ts(event, this)" ontouchmove="tm(event, this)" ontouchend="te(event, this, ${msg.id}, '${b64Text}')">
                        ${senderName} ${replyHtml} ${mediaHtml} ${txtHtml}
                        <div class="text-[10px] opacity-60 text-right mt-1 font-medium tracking-wide">${formatTime(msg.timestamp)}</div>
                    </div>
                </div>`;
        });
        setTimeout(() => { box.scrollTop = box.scrollHeight; }, 50);
    }

    // --- SIMPAN & POLLING ---
    function simpanPesan(chatId, nama, text, sender, msgId, type, mediaUrl='', replyText=null, chatType='private', realSender=null) {
        let safeName = nama && nama !== "undefined" ? nama : "Pengguna";
        
        if (!chatsData[chatId]) chatsData[chatId] = { id: chatId, name: safeName, type: chatType, unread: 0, avatar: '', messages: [] };
        else { chatsData[chatId].name = safeName; chatsData[chatId].type = chatType; }
        if (sender === 'user' && activeChatId !== chatId) chatsData[chatId].unread = (chatsData[chatId].unread || 0) + 1;
        
        chatsData[chatId].messages.push({ id: msgId, text, sender, type, mediaUrl, replyToText: replyText, realSender, timestamp: Date.now() });
        let botId = bots.find(b => b.token === activeToken).id; localStorage.setItem(`dz_chats_v14_${botId}`, JSON.stringify(chatsData));
        renderSidebar(); if (activeChatId == chatId) renderMessages();
        
        if(sender === 'user' && !chatsData[chatId].avatar) {
            tgApi('getUserProfilePhotos', { user_id: chatId, limit: 1 }).then(async res => {
                if (res.ok && res.result.total_count > 0) {
                    let fRes = await tgApi('getFile', { file_id: res.result.photos[0][0].file_id });
                    if(fRes.ok) { chatsData[chatId].avatar = `https://api.telegram.org/file/bot${activeToken}/${fRes.result.file_path}`;
                        localStorage.setItem(`dz_chats_v14_${botId}`, JSON.stringify(chatsData)); renderSidebar(); }
                }
            });
        }
    }

    function startPolling() {
        if(pollingInterval) clearInterval(pollingInterval);
        let botId = bots.find(b => b.token === activeToken).id;
        let offsetKey = `offset_v14_${botId}`; let localOffset = parseInt(localStorage.getItem(offsetKey)) || 0;
        
        pollingInterval = setInterval(async () => {
            let res = await tgApi('getUpdates', { offset: localOffset + 1 });
            if (res.ok && res.result.length > 0) {
                for (let update of res.result) {
                    localOffset = update.update_id; localStorage.setItem(offsetKey, localOffset);
                    if (update.message) {
                        let msg = update.message; let type = 'text'; let mediaUrl = ''; let teks = msg.text || msg.caption || '';
                        let chatName = "Unknown";
                        if(msg.chat.type === 'private') { chatName = msg.from.first_name + (msg.from.last_name ? ' ' + msg.from.last_name : ''); } 
                        else { chatName = msg.chat.title || "Grup"; }

                        let fileId = null;
                        if (msg.photo) { type = 'photo'; fileId = msg.photo[msg.photo.length - 1].file_id; }
                        else if (msg.video || (msg.document && msg.document.mime_type?.startsWith('video/'))) { type = 'video'; fileId = msg.video ? msg.video.file_id : msg.document.file_id; }
                        else if (msg.audio || msg.voice) { type = 'audio'; fileId = msg.audio ? msg.audio.file_id : msg.voice.file_id; }
                        else if (msg.sticker) { type = 'sticker'; fileId = msg.sticker.file_id; teks = msg.sticker.emoji || 'Stiker'; }

                        if(fileId) {
                            let fRes = await tgApi('getFile', {file_id: fileId});
                            if(fRes.ok) mediaUrl = `https://api.telegram.org/file/bot${activeToken}/${fRes.result.file_path}`;
                        }
                        
                        let replyTxt = msg.reply_to_message ? (msg.reply_to_message.text || 'Media') : null;
                        let realSnd = msg.from.first_name + (msg.from.last_name ? ' ' + msg.from.last_name : '');
                        simpanPesan(msg.chat.id.toString(), chatName, teks, 'user', msg.message_id, type, mediaUrl, replyTxt, msg.chat.type, realSnd);
                    }
                }
            }
        }, 2000);
    }

    // --- KIRIM ---
    async function handleFileUpload() {
        let f = document.getElementById('fileUpload').files[0]; if (!f || !activeChatId) return;
        let isVid = f.type.startsWith('video/'); let isAud = f.type.startsWith('audio/');
        let method = isVid ? 'sendVideo' : (isAud ? 'sendAudio' : 'sendDocument');
        if(f.type.startsWith('image/')) method = 'sendPhoto';
        let param = method.replace('send', '').toLowerCase();
        let fd = new FormData(); fd.append('chat_id', activeChatId); fd.append(param, f);
        if(replyToMsgId) fd.append('reply_to_message_id', replyToMsgId);
        
        showToast('Mengirim file...');
        let res = await tgApi(method, fd, true);
        if(res.ok) { simpanPesan(activeChatId, chatsData[activeChatId].name, '', 'bot', res.result.message_id, param, URL.createObjectURL(f), null); cancelAction(); }
        else showToast('Gagal ngirim file', 'error');
    }

    async function kirimPesan() {
        if (!activeChatId) return showToast('Pilih chat dulu bang!', 'error'); 
        let text = document.getElementById('msgInput').value.trim(); if (!text) return;
        
        if(editMsgId) {
            let res = await tgApi('editMessageText', {chat_id: activeChatId, message_id: editMsgId, text: text, parse_mode: 'HTML'});
            if(res.ok) {
                let msgIdx = chatsData[activeChatId].messages.findIndex(m => m.id === editMsgId);
                if(msgIdx > -1) chatsData[activeChatId].messages[msgIdx].text = text;
                let botId = bots.find(b => b.token === activeToken).id; localStorage.setItem(`dz_chats_v14_${botId}`, JSON.stringify(chatsData));
                renderMessages(); cancelAction(); showToast('Pesan diedit!');
            } else showToast('Gagal edit pesan', 'error');
            return;
        }

        document.getElementById('msgInput').value = ''; document.getElementById('msgInput').style.height='';
        let payload = { chat_id: activeChatId, text: text, parse_mode: 'HTML' }; 
        if(replyToMsgId) payload.reply_to_message_id = replyToMsgId;
        
        let res = await tgApi('sendMessage', payload);
        if (res.ok) { simpanPesan(activeChatId, chatsData[activeChatId].name, text, 'bot', res.result.message_id, 'text', '', replyToMsgId ? document.getElementById('action-text-ui').innerText : null); cancelAction(); }
        else showToast('Gagal ngirim', 'error');
    }
</script>
</body>
</html>
