<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>DezzBGram - Ultimate Workspace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { height: 100dvh; background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
    .hide-scroll::-webkit-scrollbar { display: none; }

    /* Premium Glass & Animations */
    .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
    .modal-enter { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    .slide-up { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    .toast-enter { animation: slideLeft 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

    @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
    @keyframes slideUp { 0% { opacity: 0; transform: translateY(100%); } 100% { opacity: 1; transform: translateY(0); } }
    @keyframes slideLeft { 0% { opacity: 0; transform: translateX(100%); } 100% { opacity: 1; transform: translateX(0); } }

    /* Chat Bubbles Style */
    .chat-user { background: #ffffff; border: 1px solid #e5e7eb; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .chat-bot { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border-bottom-right-radius: 4px; box-shadow: 0 2px 8px rgba(37,99,235,0.25); }

    /* Input Area Transition */
    .input-focus-ring:focus-within { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); border-color: #3b82f6; }

    /* Hide delete button until hover (desktop) */
    .chat-item .chat-del { opacity: 0; pointer-events: none; transform: translateX(6px); }
    .chat-item:hover .chat-del { opacity: 1; pointer-events: auto; transform: translateX(0); }

    @media (max-width: 768px) {
      .mobile-view-chat #sidebar { transform: translateX(-100%); }
      .mobile-view-chat #chat-area { transform: translateX(0); }
      .chat-item .chat-del { opacity: 1; pointer-events: auto; transform: none; } /* mobile always visible */
    }
  </style>
</head>

<body class="text-gray-800 antialiased overflow-hidden flex w-full" id="main-body">

  <div id="toast-container" class="fixed top-5 right-5 z-[9999] flex flex-col gap-3 pointer-events-none"></div>

  <div id="general-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[999] flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 modal-enter text-center" id="general-modal-content"></div>
  </div>

  <div id="msg-action-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[999] flex items-end md:items-center justify-center p-0 md:p-4 hidden" onclick="closeModal('msg-action-modal')">
    <div class="bg-white w-full md:w-80 rounded-t-3xl md:rounded-2xl shadow-2xl slide-up md:modal-enter overflow-hidden flex flex-col max-h-[85vh]" onclick="event.stopPropagation()">

      <div class="w-full flex justify-center pt-3 md:hidden pb-1">
        <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
      </div>

      <div class="px-5 py-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center shrink-0">
        <div class="overflow-hidden pr-3">
          <h3 class="font-bold text-gray-900 text-[15px]">Tindakan Pesan</h3>
          <p id="action-msg-preview" class="text-xs text-gray-500 truncate mt-0.5">Preview...</p>
        </div>
        <button onclick="actionCopy()" class="text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-2 rounded-xl text-xs font-bold transition flex items-center gap-1.5 shrink-0">
          <i class="fa-regular fa-copy"></i> Salin
        </button>
      </div>

      <div class="flex flex-col p-2 overflow-y-auto hide-scroll">
        <button onclick="actionReply()" class="flex items-center gap-3.5 p-3.5 hover:bg-blue-50 text-gray-700 rounded-xl transition font-semibold text-[14px]">
          <i class="fa-solid fa-reply w-5 text-center text-blue-500 text-lg"></i> Balas Pesan
        </button>
        <button onclick="actionEdit()" id="btn-edit-msg" class="flex items-center gap-3.5 p-3.5 hover:bg-yellow-50 text-gray-700 rounded-xl transition font-semibold text-[14px]">
          <i class="fa-solid fa-pen w-5 text-center text-yellow-500 text-lg"></i> Edit Pesan
        </button>
        <button onclick="actionForward()" class="flex items-center gap-3.5 p-3.5 hover:bg-indigo-50 text-gray-700 rounded-xl transition font-semibold text-[14px]">
          <i class="fa-solid fa-share w-5 text-center text-indigo-500 text-lg"></i> Teruskan...
        </button>
        <button onclick="actionRepeat()" class="flex items-center gap-3.5 p-3.5 hover:bg-emerald-50 text-gray-700 rounded-xl transition font-semibold text-[14px]">
          <i class="fa-solid fa-rotate-right w-5 text-center text-emerald-500 text-lg"></i> Kirim Ulang
        </button>
        <button onclick="actionPin()" class="flex items-center gap-3.5 p-3.5 hover:bg-orange-50 text-gray-700 rounded-xl transition font-semibold text-[14px]">
          <i class="fa-solid fa-thumbtack w-5 text-center text-orange-500 text-lg"></i> Sematkan (Pin)
        </button>
        <div class="h-px bg-gray-100 my-1 mx-2"></div>
        <button onclick="actionDelete()" class="flex items-center gap-3.5 p-3.5 hover:bg-red-50 text-red-600 rounded-xl transition font-bold text-[14px]">
          <i class="fa-solid fa-trash-can w-5 text-center text-lg"></i> Hapus Pesan
        </button>
      </div>
    </div>
  </div>

  <div class="flex w-full h-full relative" id="app-container" style="display: none;">

    <!-- NAV RAIL -->
    <div class="w-full md:w-[76px] bg-[#111827] border-t md:border-t-0 md:border-r border-slate-800 flex md:flex-col items-center justify-around md:justify-start md:py-6 md:gap-4 absolute md:relative bottom-0 z-40 h-[60px] md:h-full shrink-0 px-2 md:px-0 overflow-x-auto hide-scroll shadow-[0_-4px_10px_rgba(0,0,0,0.1)] md:shadow-none">
      <button onclick="showTools('dezzbgram')" title="DezzBGram Info" class="w-[42px] h-[42px] rounded-[14px] bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-lg flex items-center justify-center transition hover:scale-105 shrink-0">
        <i class="fa-solid fa-bolt"></i>
      </button>
      <button onclick="showTools('broadcast')" title="Broadcast" class="w-[42px] h-[42px] rounded-[14px] bg-white/10 text-gray-300 hover:text-white hover:bg-white/20 flex items-center justify-center transition shrink-0">
        <i class="fa-solid fa-bullhorn"></i>
      </button>
      <button onclick="showTools('ttdl')" title="TikTok DL" class="w-[42px] h-[42px] rounded-[14px] bg-white/10 text-gray-300 hover:text-white hover:bg-white/20 flex items-center justify-center transition shrink-0">
        <i class="fa-brands fa-tiktok"></i>
      </button>
      <button onclick="showTools('login')" title="Tambah Bot" class="w-[42px] h-[42px] rounded-[14px] bg-blue-500/20 text-blue-400 hover:bg-blue-500 hover:text-white flex items-center justify-center transition shrink-0">
        <i class="fa-solid fa-plus"></i>
      </button>

      <div class="hidden md:block w-8 h-px bg-white/10 my-1"></div>
      <div class="md:hidden h-6 w-px bg-white/10 mx-1"></div>

      <div id="bot-list-container" class="flex md:flex-col gap-3 shrink-0 items-center"></div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar" class="w-full md:w-[320px] bg-white border-r border-gray-200 flex flex-col absolute md:relative z-20 h-[calc(100%-60px)] md:h-full shrink-0 transform translate-x-0 transition-transform duration-300">

      <div class="p-4 border-b border-gray-100 bg-white shadow-[0_2px_5px_rgba(0,0,0,0.02)] shrink-0 flex items-center justify-between">
        <div class="flex items-center gap-3 overflow-hidden">
          <img id="active-bot-avatar" src="https://ui-avatars.com/api/?name=Bot" class="w-11 h-11 rounded-full object-cover shadow-sm border border-gray-100" />
          <div class="overflow-hidden">
            <h2 id="active-bot-name" class="font-bold text-gray-900 text-[15px] truncate">Memuat...</h2>
            <p id="active-bot-username" class="text-[12px] text-blue-500 font-medium truncate">@username</p>
          </div>
        </div>
        <button onclick="confirmLogoutBot()" title="Logout" class="w-9 h-9 rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition shrink-0 ml-2">
          <i class="fa-solid fa-power-off text-sm"></i>
        </button>
      </div>

      <!-- SEARCH BAR (REALTIME) -->
      <div class="px-3 pt-3 pb-1 bg-white">
        <div class="bg-gray-100 rounded-xl px-3 py-2 flex items-center gap-2 text-gray-500 border border-transparent focus-within:border-blue-200 focus-within:bg-white transition">
          <i class="fa-solid fa-magnifying-glass text-xs text-gray-400"></i>
          <input id="chat-search" type="text" placeholder="Cari obrolan..." class="w-full bg-transparent outline-none text-sm text-gray-700 placeholder:text-gray-400" oninput="renderSidebar()" />
        </div>
      </div>

      <div id="chat-list" class="flex-1 overflow-y-auto hide-scroll p-2 space-y-0.5 bg-white"></div>
    </div>

    <!-- CHAT AREA -->
    <div id="chat-area" class="w-full absolute md:relative z-30 h-[calc(100%-60px)] md:h-full bg-[#e4e4e7] flex flex-col transform translate-x-full md:translate-x-0 transition-transform duration-300">

      <div class="h-[65px] border-b border-gray-200 flex items-center px-4 glass shrink-0 z-10 cursor-pointer" onclick="showTools('device')">
        <button onclick="event.stopPropagation(); closeMobileChat()" class="md:hidden mr-3 w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 active:scale-95">
          <i class="fa-solid fa-arrow-left"></i>
        </button>
        <img id="header-avatar" src="https://ui-avatars.com/api/?name=U" class="w-10 h-10 rounded-full object-cover mr-3 border border-white shadow-sm bg-white" />
        <div class="flex-1 overflow-hidden">
          <h3 id="header-name" class="font-bold text-gray-900 truncate text-[16px]">Pilih Obrolan</h3>
          <p id="header-sub" class="text-[12px] text-green-600 font-medium truncate">Online 24/7</p>
        </div>
      </div>

      <div id="messages-container" class="flex-1 overflow-y-auto hide-scroll p-4 md:p-6 space-y-3 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] relative"></div>

      <div class="bg-white shrink-0 shadow-[0_-4px_20px_rgba(0,0,0,0.04)] z-10 flex flex-col">

        <div class="flex items-center gap-1.5 px-4 py-2 bg-gray-50/80 border-b border-gray-100 overflow-x-auto hide-scroll">
          <button onclick="formatText('b')" class="w-7 h-7 rounded-md hover:bg-gray-200 font-bold text-gray-700 text-sm transition">B</button>
          <button onclick="formatText('i')" class="w-7 h-7 rounded-md hover:bg-gray-200 italic font-serif text-gray-700 text-sm transition">I</button>
          <button onclick="formatText('s')" class="w-7 h-7 rounded-md hover:bg-gray-200 line-through text-gray-700 text-sm transition">S</button>
          <button onclick="formatText('code')" class="px-2 h-7 rounded-md hover:bg-gray-200 font-mono text-gray-600 text-[11px] border border-gray-200 transition">Code</button>

          <div class="mx-1 w-px h-6 bg-gray-200"></div>

          <!-- EXTRA TOOLS (TANPA NGERUSAK UI) -->
          <button onclick="showTools('poll')" title="Buat Polling" class="w-8 h-8 rounded-lg hover:bg-gray-200 text-gray-600 transition flex items-center justify-center">
            <i class="fa-solid fa-chart-column text-[14px]"></i>
          </button>
          <button onclick="showTools('quick')" title="Quick Tools" class="w-8 h-8 rounded-lg hover:bg-gray-200 text-gray-600 transition flex items-center justify-center">
            <i class="fa-solid fa-wand-magic-sparkles text-[14px]"></i>
          </button>
        </div>

        <div id="action-indicator" class="hidden items-center justify-between bg-white border-l-4 border-blue-500 pl-3 pr-2 py-2 mx-4 mt-3 rounded-r-lg shadow-[0_2px_8px_rgba(0,0,0,0.04)]">
          <div class="overflow-hidden flex flex-col justify-center">
            <span id="action-label" class="text-[11px] font-bold text-blue-600 mb-0.5 leading-none">Membalas Pesan</span>
            <span id="action-text-ui" class="text-[13px] text-gray-600 truncate leading-none mt-0.5">...</span>
          </div>
          <button onclick="cancelAction()" class="w-7 h-7 rounded-full text-gray-400 hover:bg-gray-100 hover:text-red-500 flex justify-center items-center transition">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="flex items-end gap-2 p-3 md:p-4">
          <button onclick="document.getElementById('fileUpload').click()" class="w-11 h-11 rounded-full text-gray-500 hover:bg-gray-100 flex items-center justify-center transition shrink-0 mb-0.5">
            <i class="fa-solid fa-paperclip text-[20px]"></i>
          </button>
          <input type="file" id="fileUpload" class="hidden" accept="image/*,audio/*,video/*" onchange="handleFileUpload()" />

          <!-- POLL BUTTON (SEBELAH PAPERCLIP) -->
          <button onclick="showTools('poll')" class="w-11 h-11 rounded-full text-gray-500 hover:bg-gray-100 flex items-center justify-center transition shrink-0 mb-0.5" title="Polling">
            <i class="fa-solid fa-chart-pie text-[18px]"></i>
          </button>

          <div class="flex-1 bg-gray-100 rounded-3xl flex items-center px-4 py-1 border border-transparent input-focus-ring transition duration-200">
            <textarea id="msgInput" rows="1" placeholder="Ketik pesan..." class="w-full bg-transparent border-none focus:ring-0 py-2.5 outline-none text-[15px] resize-none hide-scroll" style="min-height: 44px; max-height: 120px;" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
          </div>

          <button id="send-btn" onclick="kirimPesan()" class="w-[46px] h-[46px] rounded-full bg-blue-600 text-white hover:bg-blue-700 flex items-center justify-center shadow-lg shadow-blue-600/30 active:scale-90 shrink-0 transition mb-0.5">
            <i class="fa-solid fa-paper-plane text-[18px] ml-1"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
  // --- UI UTILITIES ---
  function showToast(msg, type = 'success') {
    const c = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = `${type==='success'?'bg-slate-800':'bg-red-600'} text-white px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 toast-enter border border-white/10`;
    t.innerHTML = `<i class="fa-solid ${type==='success'?'fa-check text-green-400':'fa-xmark text-white'} text-lg"></i><span class="text-[13px] font-medium tracking-wide">${msg}</span>`;
    c.appendChild(t);
    setTimeout(() => {
      t.style.opacity='0';
      t.style.transform='translateX(100%)';
      t.style.transition='all 0.3s';
      setTimeout(()=>t.remove(),300);
    }, 2500);
  }

  function openModalGen(htmlContent) {
    document.getElementById('general-modal-content').innerHTML = htmlContent;
    document.getElementById('general-modal').classList.remove('hidden');
  }
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
  function closeGenModal() { closeModal('general-modal'); }

  // --- SAFE TEXT ---
  const stripHtml = (s='') => (s||'').replace(/<[^>]*>?/gm, '');
  const safeName = (s, fallback='Unknown') => {
    let v = (s ?? '').toString().trim();
    if(!v || v === 'undefined' || v === 'null') return fallback;
    return v;
  };

  // --- STATE MANAGEMENT ---
  let bots = JSON.parse(localStorage.getItem('dz_bots')) || [];
  let activeToken = localStorage.getItem('dz_active') || '';
  let chatsData = {};
  let activeChatId = null;
  let pollingInterval = null;

  let selectedMsgId = null;
  let selectedMsgText = "";
  let selectedMsgType = "text";
  let selectedMsgSender = "";

  let replyToMsgId = null;
  let editMsgId = null;

  // Swipe state
  let swipe = { active:false, startX:0, startY:0, moved:false, msgId:null, msgText:'', lock:false };

  // --- AUTO LOGIN CHECK ---
  window.onload = () => {
    if (bots.length === 0 || !activeToken) showTools('login');
    else initApp();
  };

  // --- API TELEGRAM ---
  async function tgApi(method, payload = {}, isFormData = false) {
    let opt = { method: 'POST' };
    if (isFormData) opt.body = payload;
    else { opt.headers = {'Content-Type': 'application/json'}; opt.body = JSON.stringify(payload); }
    try {
      let res = await fetch(`https://api.telegram.org/bot${activeToken}/${method}`, opt);
      return await res.json();
    } catch (e) {
      return {ok: false};
    }
  }

  // --- INIT APP & RENDER INFO BOT ---
  function initApp() {
    document.getElementById('general-modal').classList.add('hidden');
    document.getElementById('app-container').style.display = 'flex';

    let bot = bots.find(b => b.token === activeToken);
    if(!bot) { showTools('login'); return; }

    // Render Bot Info Header
    document.getElementById('active-bot-name').innerText = safeName(bot.name, 'Bot');
    document.getElementById('active-bot-username').innerText = `@${safeName(bot.username,'username')}`;
    document.getElementById('active-bot-avatar').src = bot.avatar;

    chatsData = JSON.parse(localStorage.getItem(`dz_chats_${bot.id}`)) || {};
    renderNavRail();
    renderSidebar();
    startPolling();
  }

  function renderNavRail() {
    let c = document.getElementById('bot-list-container');
    c.innerHTML = '';
    bots.forEach(b => {
      let active = b.token === activeToken ? 'border-2 border-blue-400 shadow-[0_0_12px_rgba(59,130,246,0.5)] scale-110' : 'opacity-50 hover:opacity-100 hover:scale-105';
      c.innerHTML += `<img src="${b.avatar}" title="${safeName(b.name,'Bot')}" onclick="switchBot('${b.token}')" class="w-[42px] h-[42px] rounded-[14px] object-cover cursor-pointer transition-all duration-300 ${active}">`;
    });
  }

  function switchBot(token) {
    localStorage.setItem('dz_active', token);
    location.reload();
  }

  // --- TOOL MODALS ---
  function renderSavedBotsList() {
    if(bots.length === 0) return '';
    let items = bots.map(b => {
      let isActive = b.token === activeToken;
      return `
        <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-xl p-2.5 mb-2">
          <div class="flex items-center gap-3 overflow-hidden">
            <img src="${b.avatar}" class="w-10 h-10 rounded-xl object-cover border border-gray-100 shadow-sm">
            <div class="overflow-hidden text-left">
              <div class="font-extrabold text-[13px] text-gray-900 truncate">${safeName(b.name,'Bot')}</div>
              <div class="text-[11px] text-blue-500 font-bold truncate">@${safeName(b.username,'username')}</div>
            </div>
          </div>
          <div class="flex items-center gap-2 shrink-0">
            <button onclick="useSavedBot('${b.token}')" class="px-3 py-2 rounded-xl text-xs font-extrabold ${isActive?'bg-blue-600 text-white':'bg-white border border-gray-200 text-gray-800 hover:bg-gray-100'} transition">
              Masuk
            </button>
            <button onclick="removeSavedBot('${b.token}')" class="w-9 h-9 rounded-xl bg-red-50 text-red-600 hover:bg-red-600 hover:text-white transition flex items-center justify-center" title="Hapus bot tersimpan">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>
      `;
    }).join('');
    return `
      <div class="text-left mt-5">
        <div class="flex items-center justify-between mb-2">
          <div class="font-extrabold text-gray-900 text-[13px]">Saved Bots</div>
          <div class="text-[11px] text-gray-500 font-semibold">${bots.length} bot</div>
        </div>
        <div class="max-h-60 overflow-y-auto hide-scroll pr-1">${items}</div>
      </div>
    `;
  }

  function showTools(type) {
    let html = '';

    if(type === 'login') {
      html = `
        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
          <i class="fa-solid fa-robot"></i>
        </div>
        <h2 class="text-xl font-extrabold text-gray-900 mb-1">Login Workspace</h2>
        <p class="text-[12px] text-gray-500 mb-4 font-semibold">Auto-login aktif: pilih bot tersimpan atau paste token</p>

        <input type="password" id="i-token" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-xl mb-3 text-sm font-mono text-center outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Paste Token Bot...">
        <button onclick="prosesLogin()" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl mb-2 shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">
          Masuk Sistem
        </button>

        ${renderSavedBotsList()}

        ${bots.length>0 ? `<button onclick="closeGenModal()" class="w-full mt-4 bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Tutup</button>` : ''}
      `;
    }

    else if(type === 'device') {
      html = `
        <h2 class="text-xl font-extrabold mb-4">ðŸ“± Info Device</h2>
        <div class="text-left bg-gray-50 p-4 rounded-xl text-[14px] space-y-2 border border-gray-200">
          <p><b class="text-gray-900">OS:</b> <span class="text-gray-600">${navigator.platform}</span></p>
          <p><b class="text-gray-900">Browser:</b> <span class="text-gray-600">${(navigator.userAgent || '').slice(0,60)}...</span></p>
          <p><b class="text-gray-900">Resolusi:</b> <span class="text-gray-600">${window.innerWidth} x ${window.innerHeight} px</span></p>
        </div>
        <button onclick="closeGenModal()" class="w-full mt-5 bg-red-50 text-red-600 py-3.5 rounded-xl font-bold hover:bg-red-100 transition">Tutup</button>
      `;
    }

    else if(type === 'ttdl') {
      html = `
        <h2 class="text-xl font-extrabold mb-2"><i class="fa-brands fa-tiktok"></i> TikTok DL</h2>
        <p class="text-[13px] text-gray-500 mb-5">Video dikirim otomatis tanpa watermark</p>
        <input type="text" id="i-tt" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-xl mb-4 text-sm outline-none focus:ring-2 focus:ring-pink-500 transition" placeholder="Paste Link TikTok...">
        <button onclick="prosesTTDL()" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl mb-2 shadow-lg hover:bg-black transition">Download</button>
        <button onclick="closeGenModal()" class="w-full bg-gray-100 py-3 rounded-xl font-bold text-gray-700 hover:bg-gray-200 transition">Batal</button>
      `;
    }

    else if(type === 'broadcast') {
      html = `
        <h2 class="text-xl font-extrabold mb-4">ðŸ“¢ Broadcast Pesan</h2>
        <textarea id="i-bc" rows="4" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-xl mb-4 text-[14px] outline-none focus:ring-2 focus:ring-emerald-500 transition resize-none hide-scroll" placeholder="Ketik pesan massal di sini... (Mendukung HTML)"></textarea>
        <button onclick="prosesBC()" class="w-full bg-emerald-600 text-white font-bold py-3.5 rounded-xl mb-2 shadow-lg shadow-emerald-500/30 hover:bg-emerald-700 transition">Kirim ke Semua</button>
        <button onclick="closeGenModal()" class="w-full bg-gray-100 py-3 rounded-xl font-bold text-gray-700 hover:bg-gray-200 transition">Batal</button>
      `;
    }

    else if(type === 'dezzbgram') {
      html = `
        <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-4 text-4xl shadow-xl">
          <i class="fa-solid fa-bolt"></i>
        </div>
        <h2 class="text-2xl font-black text-gray-900 mb-1">DezzBGram</h2>
        <p class="text-[13px] font-bold text-blue-600 bg-blue-50 inline-block px-3 py-1 rounded-full mb-5">Versi 10.0 (Ultimate Polish)</p>
        <button onclick="window.location.href='dev.html'" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl mb-2 hover:bg-black transition flex justify-center items-center gap-2">
          <i class="fa-solid fa-code"></i> Info Developer
        </button>
        <button onclick="closeGenModal()" class="w-full bg-gray-100 py-3 rounded-xl font-bold text-gray-700 hover:bg-gray-200 transition">Tutup</button>
      `;
    }

    else if(type === 'forward') {
      let listHTML = Object.values(chatsData).map(c =>
        `<div onclick="executeForward('${c.id}', true)" class="flex items-center p-2.5 hover:bg-gray-50 rounded-xl cursor-pointer transition">
          <img src="${c.avatar||`https://ui-avatars.com/api/?name=${encodeURIComponent(c.name||'Chat')}`}" class="w-9 h-9 rounded-full mr-3 border border-gray-100">
          <span class="text-[14px] font-semibold text-gray-800 truncate">${safeName(c.name,'Chat')}</span>
        </div>`
      ).join('');

      html = `
        <h2 class="text-lg font-extrabold mb-4 text-left">Teruskan ke...</h2>
        <div class="flex gap-2 mb-4 bg-gray-100 p-1 rounded-xl">
          <button onclick="setFwdMode(false)" id="btn-fwd-ori" class="flex-1 bg-white shadow-sm text-gray-900 py-2 rounded-lg text-xs font-bold transition">Asli</button>
          <button onclick="setFwdMode(true)" id="btn-fwd-copy" class="flex-1 text-gray-500 py-2 rounded-lg text-xs font-bold transition">No Sender</button>
        </div>
        <div class="max-h-56 overflow-y-auto border border-gray-100 p-1 rounded-xl mb-4 hide-scroll">${listHTML || `<div class="p-4 text-sm text-gray-500 font-semibold">Belum ada chat.</div>`}</div>
        <button onclick="closeGenModal()" class="w-full bg-gray-100 py-3 rounded-xl font-bold text-gray-700 hover:bg-gray-200 transition">Batal</button>
      `;
    }

    else if(type === 'poll') {
      if(!activeChatId) {
        html = `
          <h2 class="text-xl font-extrabold mb-2">ðŸ“Š Buat Polling</h2>
          <p class="text-[13px] text-gray-500 mb-5 font-semibold">Pilih obrolan dulu biar polling-nya tau mau dikirim ke mana.</p>
          <button onclick="closeGenModal()" class="w-full bg-gray-100 py-3 rounded-xl font-bold text-gray-700 hover:bg-gray-200 transition">Tutup</button>
        `;
      } else {
        html = `
          <h2 class="text-xl font-extrabold mb-2">ðŸ“Š Buat Polling</h2>
          <p class="text-[13px] text-gray-500 mb-4">Kirim polling langsung via Telegram API.</p>

          <input id="poll-q" type="text" class="w-full p-3.5 bg-gray-50 border border-gray-200 rounded-xl mb-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Pertanyaan polling...">

          <div id="poll-opts" class="space-y-2 mb-3">
            ${pollOptRowHTML(1)}${pollOptRowHTML(2)}${pollOptRowHTML(3)}
          </div>

          <button onclick="addPollOpt()" class="w-full bg-white border border-gray-200 text-gray-800 font-bold py-3 rounded-xl mb-2 hover:bg-gray-100 transition flex items-center justify-center gap-2">
            <i class="fa-solid fa-plus"></i> Tambah Opsi
          </button>

          <div class="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-xl px-3 py-3 mb-4">
            <div class="text-left">
              <div class="text-[13px] font-extrabold text-gray-900">Mode</div>
              <div class="text-[11px] text-gray-500 font-semibold">Anonim & multiple choice default</div>
            </div>
            <label class="flex items-center gap-2 text-[12px] font-bold text-gray-700">
              <input id="poll-multi" type="checkbox" class="accent-blue-600" checked>
              Multi
            </label>
          </div>

          <button onclick="sendPoll()" class="w-full bg-blue-600 text-white font-extrabold py-3.5 rounded-xl mb-2 shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">
            Kirim Polling
          </button>
          <button onclick="closeGenModal()" class="w-full bg-gray-100 py-3 rounded-xl font-bold text-gray-700 hover:bg-gray-200 transition">Batal</button>
        `;
      }
    }

    else if(type === 'quick') {
      html = `
        <h2 class="text-xl font-extrabold mb-2">âœ¨ Quick Tools</h2>
        <p class="text-[13px] text-gray-500 mb-5">Tools kecil buat ngebut chat. Aman, nggak ngubah tampilan.</p>

        <div class="space-y-2 text-left">
          <button onclick="insertTemplate('Halo bang!')" class="w-full bg-gray-50 border border-gray-200 hover:bg-gray-100 rounded-xl p-3 font-bold text-[13px] flex items-center gap-3 transition">
            <i class="fa-solid fa-bolt text-blue-600"></i> Sisipkan: Halo bang!
          </button>
          <button onclick="insertTemplate('Oke siap, gas! âœ…')" class="w-full bg-gray-50 border border-gray-200 hover:bg-gray-100 rounded-xl p-3 font-bold text-[13px] flex items-center gap-3 transition">
            <i class="fa-solid fa-check text-emerald-600"></i> Sisipkan: Oke siap, gas!
          </button>
          <button onclick="insertTemplate('<b>INFO:</b> ')" class="w-full bg-gray-50 border border-gray-200 hover:bg-gray-100 rounded-xl p-3 font-bold text-[13px] flex items-center gap-3 transition">
            <i class="fa-solid fa-circle-info text-indigo-600"></i> Sisipkan: INFO:
          </button>
        </div>

        <button onclick="closeGenModal()" class="w-full mt-5 bg-gray-100 py-3 rounded-xl font-bold text-gray-700 hover:bg-gray-200 transition">Tutup</button>
      `;
    }

    openModalGen(html);
  }

  function pollOptRowHTML(i) {
    return `
      <div class="flex items-center gap-2">
        <div class="w-7 h-7 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center text-xs font-extrabold">${i}</div>
        <input type="text" class="poll-opt w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Opsi ${i}...">
      </div>
    `;
  }

  function addPollOpt() {
    const box = document.getElementById('poll-opts');
    if(!box) return;
    const idx = box.querySelectorAll('.poll-opt').length + 1;
    if(idx > 10) return showToast('Maks 10 opsi', 'error');
    box.insertAdjacentHTML('beforeend', pollOptRowHTML(idx));
  }

  function insertTemplate(txt) {
    closeGenModal();
    const i = document.getElementById('msgInput');
    if(!i) return;
    i.value = (i.value || '') + (i.value ? '\n' : '') + txt;
    i.focus();
    i.style.height = '';
    i.style.height = i.scrollHeight + 'px';
  }

  function useSavedBot(token) {
    localStorage.setItem('dz_active', token);
    location.reload();
  }

  function removeSavedBot(token) {
    if(!confirm('Hapus bot ini dari daftar saved?')) return;
    bots = bots.filter(b => b.token !== token);
    localStorage.setItem('dz_bots', JSON.stringify(bots));
    if(activeToken === token) {
      if(bots.length > 0) localStorage.setItem('dz_active', bots[0].token);
      else localStorage.removeItem('dz_active');
    }
    showTools('login');
  }

  // --- AKSI TOOLS ---
  async function prosesLogin() {
    let token = document.getElementById('i-token').value.trim();
    if(!token) return showToast('Isi token!', 'error');

    let res = await fetch(`https://api.telegram.org/bot${token}/getMe`);
    let data = await res.json();

    if(data.ok) {
      const id = data.result.id;
      const name = safeName(data.result.first_name, 'Bot');
      const username = safeName(data.result.username, 'username');

      // prevent duplicates
      bots = bots.filter(b => b.token !== token);

      bots.push({ token, id, name, username, avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3b82f6&color=fff`});
      localStorage.setItem('dz_bots', JSON.stringify(bots));
      localStorage.setItem('dz_active', token);
      location.reload();
    } else showToast('Token invalid!', 'error');
  }

  function confirmLogoutBot() {
    if(confirm('Logout dan hapus bot ini dari DezzBGram?')) {
      bots = bots.filter(b => b.token !== activeToken);
      localStorage.setItem('dz_bots', JSON.stringify(bots));
      if(bots.length > 0) localStorage.setItem('dz_active', bots[0].token);
      else { localStorage.removeItem('dz_active'); localStorage.removeItem('dz_bots'); }
      location.reload();
    }
  }

  async function prosesTTDL() {
    if(!activeChatId) return showToast('Pilih obrolan dulu bang!', 'error');
    let url = document.getElementById('i-tt').value;
    if(!url.includes('tiktok.com')) return showToast('Link salah', 'error');
    showToast('Download dimulai...');
    closeGenModal();
    try {
      let r = await fetch(`https://tikwm.com/api/?url=${encodeURIComponent(url)}`);
      let d = await r.json();
      if(d.code===0 && d.data.play) {
        let s = await tgApi('sendVideo', {chat_id: activeChatId, video: d.data.play, caption: `ðŸ“¥ <b>TikTok No Watermark</b>\n${safeName(d.data.title,'')}`, parse_mode: 'HTML'});
        if(s.ok) simpanPesan(activeChatId, chatsData[activeChatId].name, d.data.title, 'bot', s.result.message_id, 'video', d.data.play);
      } else showToast('Gagal ambil video', 'error');
    } catch(e) { showToast('Error API TikTok', 'error'); }
  }

  async function prosesBC() {
    let txt = document.getElementById('i-bc').value;
    if(!txt) return;
    closeGenModal();
    let cIds = Object.keys(chatsData);
    let c = 0;
    for(let id of cIds) {
      let r = await tgApi('sendMessage', {chat_id: id, text: `[BROADCAST]\n\n${txt}`, parse_mode: 'HTML'});
      if(r.ok) { c++; simpanPesan(id, chatsData[id].name, `[BROADCAST]\n${txt}`, 'bot', r.result.message_id, 'text'); }
    }
    showToast(`Terkirim ke ${c} chat!`);
  }

  async function sendPoll() {
    const q = (document.getElementById('poll-q')?.value || '').trim();
    if(!q) return showToast('Isi pertanyaan!', 'error');

    const opts = [...document.querySelectorAll('.poll-opt')]
      .map(i => (i.value||'').trim())
      .filter(Boolean);

    if(opts.length < 2) return showToast('Minimal 2 opsi', 'error');
    if(opts.some(o => o.length > 100)) return showToast('Opsi kepanjangan', 'error');

    const multi = !!document.getElementById('poll-multi')?.checked;

    showToast('Mengirim polling...');
    closeGenModal();

    const res = await tgApi('sendPoll', {
      chat_id: activeChatId,
      question: q,
      options: JSON.stringify(opts),
      is_anonymous: true,
      allows_multiple_answers: multi
    });

    if(res.ok) {
      simpanPesan(activeChatId, chatsData[activeChatId].name, `ðŸ“Š Polling: ${q}`, 'bot', res.result.message_id, 'text');
      showToast('Polling terkirim!');
    } else {
      showToast('Gagal kirim polling', 'error');
    }
  }

  let isCopyFwd = false;
  function setFwdMode(isCopy) {
    isCopyFwd = isCopy;
    document.getElementById('btn-fwd-copy').className = isCopy ? 'flex-1 bg-white shadow-sm text-gray-900 py-2 rounded-lg text-xs font-bold transition' : 'flex-1 text-gray-500 py-2 rounded-lg text-xs font-bold transition';
    document.getElementById('btn-fwd-ori').className = !isCopy ? 'flex-1 bg-white shadow-sm text-gray-900 py-2 rounded-lg text-xs font-bold transition' : 'flex-1 text-gray-500 py-2 rounded-lg text-xs font-bold transition';
  }

  async function executeForward(targetId) {
    closeGenModal();
    let method = isCopyFwd ? 'copyMessage' : 'forwardMessage';
    let res = await tgApi(method, {chat_id: targetId, from_chat_id: activeChatId, message_id: selectedMsgId});
    if(res.ok) { showToast('Pesan Diteruskan!'); simpanPesan(targetId, chatsData[targetId].name, "[Pesan Diteruskan]", 'bot', res.result.message_id, 'text'); }
    else showToast('Gagal teruskan', 'error');
  }

  function formatText(tag) {
    let i = document.getElementById('msgInput');
    let start = i.selectionStart;
    let end = i.selectionEnd;
    let text = i.value;
    let sel = text.substring(start, end) || "teks";
    let rep = `<${tag}>${sel}</${tag}>`;
    if(tag === 'code') rep = `<code>${sel}</code>`;
    i.value = text.substring(0, start) + rep + text.substring(end);
    i.focus();
  }

  // --- RENDER SIDEBAR (WITH SEARCH + DELETE CHAT) ---
  function renderSidebar() {
    const list = document.getElementById('chat-list');
    list.innerHTML = '';

    const q = (document.getElementById('chat-search')?.value || '').trim().toLowerCase();

    let arr = Object.values(chatsData).sort((a,b) => (b.messages[b.messages.length-1]?.timestamp||0) - (a.messages[a.messages.length-1]?.timestamp||0));

    if(q) {
      arr = arr.filter(c => (safeName(c.name,'').toLowerCase().includes(q) || safeName(c.id,'').toLowerCase().includes(q)));
    }

    if(arr.length === 0) {
      list.innerHTML = `
        <div class="p-6 text-center text-gray-500">
          <div class="w-14 h-14 rounded-2xl bg-gray-100 mx-auto flex items-center justify-center mb-3">
            <i class="fa-solid fa-comments text-gray-400 text-xl"></i>
          </div>
          <div class="font-extrabold text-[14px] text-gray-700 mb-1">Tidak ada hasil</div>
          <div class="text-[12px] font-semibold">Coba kata kunci lain.</div>
        </div>
      `;
      return;
    }

    arr.forEach(c => {
      let last = c.messages?.[c.messages.length - 1];
      let txt = last ? (last.type==='service'?'ðŸ“Œ Pesan disematkan':(last.type==='photo'?'ðŸ“· Gambar':(last.type==='video'?'ðŸŽ¥ Video':(last.type==='audio'?'ðŸŽµ Audio':(last.type==='sticker'?'ðŸŒŸ Stiker':last.text))))) : 'Mulai obrolan...';
      let act = activeChatId == c.id ? 'bg-blue-50' : 'bg-white hover:bg-gray-50';
      let badge = c.type !== 'private' ? `<span class="bg-indigo-100 text-indigo-700 px-1.5 py-[2px] rounded text-[9px] font-extrabold ml-1.5 tracking-wide">GRUP</span>` : '';
      let unread = c.unread > 0 ? `<div class="bg-blue-600 text-white text-[10px] font-bold h-5 w-5 rounded-full flex items-center justify-center shrink-0 ml-2 shadow-sm">${c.unread}</div>` : '';

      list.innerHTML += `
        <div class="chat-item flex items-center px-3 py-2.5 rounded-xl cursor-pointer transition ${act}" onclick="openChat('${c.id}')">
          <img src="${c.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(safeName(c.name,'Chat'))}`}" class="w-[46px] h-[46px] rounded-full object-cover mr-3.5 shrink-0 border border-gray-200">
          <div class="flex-1 overflow-hidden">
            <div class="flex justify-between items-center mb-0.5">
              <h4 class="font-bold text-gray-900 text-[14.5px] truncate">${safeName(c.name,'Chat')} ${badge}</h4>
              <div class="flex items-center gap-2 shrink-0">
                ${unread}
                <button class="chat-del w-9 h-9 rounded-full bg-gray-100 text-gray-600 hover:bg-red-50 hover:text-red-600 transition flex items-center justify-center" title="Hapus chat" onclick="event.stopPropagation(); confirmDeleteChat('${c.id}')">
                  <i class="fa-solid fa-trash-can text-[13px]"></i>
                </button>
              </div>
            </div>
            <p class="text-[13px] text-gray-500 truncate">${stripHtml(txt || '').substring(0,90)}</p>
          </div>
        </div>
      `;
    });
  }

  function confirmDeleteChat(chatId) {
    const c = chatsData[chatId];
    const name = safeName(c?.name,'Chat');
    if(!confirm(`Hapus chat "${name}" dari daftar? (Local only)`)) return;

    delete chatsData[chatId];
    const botId = bots.find(b => b.token === activeToken)?.id;
    if(botId) localStorage.setItem(`dz_chats_${botId}`, JSON.stringify(chatsData));

    if(activeChatId === chatId) {
      activeChatId = null;
      closeMobileChat();
      document.getElementById('header-name').innerText = 'Pilih Obrolan';
      document.getElementById('header-sub').innerText = 'Online 24/7';
      document.getElementById('header-avatar').src = 'https://ui-avatars.com/api/?name=U';
      document.getElementById('messages-container').innerHTML = '';
    }
    renderSidebar();
    showToast('Chat dihapus');
  }

  function openChat(chatId) {
    activeChatId = chatId;
    chatsData[chatId].unread = 0;
    let botId = bots.find(b => b.token === activeToken).id;
    localStorage.setItem(`dz_chats_${botId}`, JSON.stringify(chatsData));

    document.getElementById('main-body').classList.add('mobile-view-chat');
    document.getElementById('header-name').innerText = safeName(chatsData[chatId].name,'Chat');
    document.getElementById('header-avatar').src = chatsData[chatId].avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(safeName(chatsData[chatId].name,'Chat'))}`;
    document.getElementById('header-sub').innerText = chatsData[chatId].type !== 'private' ? 'Grup Obrolan' : 'Private Chat';

    renderMessages();
    renderSidebar();
  }

  function closeMobileChat() {
    document.getElementById('main-body').classList.remove('mobile-view-chat');
    activeChatId = null;
    renderSidebar();
  }

  function formatTime(ts) {
    let d = new Date(ts);
    return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
  }

  // --- ACTION MODAL ---
  function showMsgAction(id, txt, type, sender) {
    // block click if swipe just happened
    if(swipe.lock) { swipe.lock = false; return; }

    selectedMsgId = id;
    selectedMsgText = txt;
    selectedMsgType = type;
    selectedMsgSender = sender;

    document.getElementById('action-msg-preview').innerText = txt ? stripHtml(txt).substring(0,40) + "..." : "Media / File Audio";
    document.getElementById('btn-edit-msg').style.display = sender === 'bot' && type === 'text' ? 'flex' : 'none';
    document.getElementById('msg-action-modal').classList.remove('hidden');
  }

  function setActionUI(label, txt) {
    document.getElementById('action-indicator').classList.replace('hidden', 'flex');
    document.getElementById('action-label').innerText = label;
    document.getElementById('action-text-ui').innerText = stripHtml(txt || '');
    document.getElementById('msgInput').focus();
  }

  function actionReply() {
    closeModal('msg-action-modal');
    replyToMsgId = selectedMsgId;
    editMsgId = null;
    setActionUI("Membalas Pesan", selectedMsgText || "Media");
  }

  function actionEdit() {
    closeModal('msg-action-modal');
    editMsgId = selectedMsgId;
    replyToMsgId = null;
    document.getElementById('msgInput').value = selectedMsgText;
    setActionUI("Edit Pesan", selectedMsgText);
    document.getElementById('send-btn').innerHTML = `<i class="fa-solid fa-check text-[18px]"></i>`;
  }

  function actionForward() { closeModal('msg-action-modal'); showTools('forward'); }

  function actionCopy() {
    closeModal('msg-action-modal');
    navigator.clipboard.writeText(selectedMsgText || '');
    showToast('Teks berhasil disalin!');
  }

  async function actionRepeat() {
    closeModal('msg-action-modal');
    let res = await tgApi('copyMessage', {chat_id: activeChatId, from_chat_id: activeChatId, message_id: selectedMsgId});
    if(res.ok) {
      simpanPesan(activeChatId, chatsData[activeChatId].name, selectedMsgText, 'bot', res.result.message_id, selectedMsgType, chatsData[activeChatId].messages.find(m=>m.id===selectedMsgId)?.mediaUrl);
      showToast('Pesan diulang!');
    }
  }

  async function actionPin() {
    closeModal('msg-action-modal');
    let res = await tgApi('pinChatMessage', {chat_id: activeChatId, message_id: selectedMsgId});
    if(res.ok) {
      let botName = bots.find(b => b.token === activeToken)?.name || 'Bot';
      simpanPesan(activeChatId, chatsData[activeChatId].name, `ðŸ“Œ ${safeName(botName,'Bot')} menyematkan pesan '${stripHtml(selectedMsgText).substring(0,25)}...'`, 'bot', Date.now(), 'service');
      showToast('Pesan disematkan');
    }
  }

  async function actionDelete() {
    closeModal('msg-action-modal');
    await tgApi('deleteMessage', {chat_id: activeChatId, message_id: selectedMsgId});
    chatsData[activeChatId].messages = chatsData[activeChatId].messages.filter(m => m.id !== selectedMsgId);
    let botId = bots.find(b => b.token === activeToken).id;
    localStorage.setItem(`dz_chats_${botId}`, JSON.stringify(chatsData));
    renderMessages();
    renderSidebar();
    showToast('Pesan dihapus');
  }

  function cancelAction() {
    replyToMsgId = null;
    editMsgId = null;
    document.getElementById('action-indicator').classList.replace('flex', 'hidden');
    document.getElementById('msgInput').value='';
    document.getElementById('msgInput').style.height='';
    document.getElementById('send-btn').innerHTML = `<i class="fa-solid fa-paper-plane text-[18px] ml-1"></i>`;
  }

  // --- SWIPE TO REPLY (MOBILE + DESKTOP TOUCH) ---
  function bindSwipe(el, msg) {
    const threshold = 45;
    el.addEventListener('touchstart', (e) => {
      if(!e.touches || e.touches.length !== 1) return;
      swipe.active = true;
      swipe.moved = false;
      swipe.startX = e.touches[0].clientX;
      swipe.startY = e.touches[0].clientY;
      swipe.msgId = msg.id;
      swipe.msgText = msg.text || '';
      swipe.lock = false;
    }, {passive:true});

    el.addEventListener('touchmove', (e) => {
      if(!swipe.active || !e.touches || e.touches.length !== 1) return;
      const dx = e.touches[0].clientX - swipe.startX;
      const dy = e.touches[0].clientY - swipe.startY;
      if(Math.abs(dy) > 16) return; // allow scroll
      if(dx < -8) swipe.moved = true; // left swipe start
      // no visual translate (biar tampilan aman)
    }, {passive:true});

    el.addEventListener('touchend', () => {
      if(!swipe.active) return;
      swipe.active = false;

      // detect left swipe
      // we can't read last dx from touchend reliably without tracking; do minimal:
      // if user moved left and ended, trigger reply by checking moved flag + small time window
      if(swipe.moved) {
        // lock click so it won't open action modal
        swipe.lock = true;
        selectedMsgId = swipe.msgId;
        selectedMsgText = swipe.msgText;
        selectedMsgType = msg.type || 'text';
        selectedMsgSender = msg.sender || 'user';
        replyToMsgId = swipe.msgId;
        editMsgId = null;
        setActionUI("Membalas Pesan", swipe.msgText || "Media");
        showToast('Mode Reply aktif');
      }
      swipe.moved = false;
    }, {passive:true});
  }

  // --- RENDER BUBBLE CHAT ---
  function renderMessages() {
    if (!activeChatId) return;
    const box = document.getElementById('messages-container');
    box.innerHTML = '';
    let chat = chatsData[activeChatId];

    chat.messages.forEach(msg => {
      if (msg.type === 'service') {
        box.innerHTML += `<div class="flex justify-center my-3"><div class="bg-gray-400/20 text-gray-600 text-[11px] px-3.5 py-1.5 rounded-full font-semibold backdrop-blur-sm border border-gray-400/10 shadow-sm">${safeName(msg.text,'')}</div></div>`;
        return;
      }

      let isUser = msg.sender === 'user';
      let alignCls = isUser ? 'items-start' : 'items-end';
      let bubCls = isUser ? 'chat-user' : 'chat-bot';

      let senderName = (chat.type !== 'private' && isUser && msg.realSender) ? `<div class="text-[11px] font-extrabold text-blue-500 mb-1 leading-none tracking-wide">${safeName(msg.realSender,'User')}</div>` : '';
      let replyHtml = msg.replyToText ? `<div class="bg-black/5 border-l-[3px] border-black/20 px-2 py-1.5 rounded mb-1.5 text-[11px] opacity-90 truncate max-w-full"><span class="font-bold text-blue-500 block mb-0.5">Membalas</span> ${stripHtml(msg.replyToText)}</div>` : '';

      let mediaHtml = '';
      if(msg.type === 'photo') mediaHtml = `<img src="${msg.mediaUrl}" class="rounded-xl mb-2 max-w-[240px] border border-black/5 shadow-sm">`;
      if(msg.type === 'video') mediaHtml = `<video src="${msg.mediaUrl}" controls class="rounded-xl mb-2 max-w-[240px] border border-black/5 shadow-sm"></video>`;
      if(msg.type === 'audio') mediaHtml = `<audio src="${msg.mediaUrl}" controls class="h-10 max-w-[240px] mb-1 outline-none"></audio>`;
      if(msg.type === 'sticker') mediaHtml = `<img src="${msg.mediaUrl}" class="w-36 h-36 mb-1 drop-shadow-lg">`;

      let safeText = (msg.text || '').replace(/'/g, "\\'").replace(/\n/g, "\\n");
      let txtHtml = msg.text ? `<div class="text-[15px] leading-relaxed break-words whitespace-pre-wrap">${msg.text}</div>` : '';

      const bubbleId = `bub_${msg.id}_${Math.random().toString(16).slice(2)}`;

      box.innerHTML += `
        <div class="flex flex-col ${alignCls} w-full mb-1.5">
          <div id="${bubbleId}" class="max-w-[85%] px-3.5 py-2.5 rounded-2xl ${bubCls} cursor-pointer active:scale-[0.97] transition-transform"
               onclick="showMsgAction(${msg.id}, '${safeText}', '${msg.type}', '${msg.sender}')">
            ${senderName} ${replyHtml} ${mediaHtml} ${txtHtml}
            <div class="text-[10px] opacity-60 text-right mt-1 font-medium tracking-wide">${formatTime(msg.timestamp)}</div>
          </div>
        </div>
      `;

      // bind swipe after injected
      setTimeout(() => {
        const el = document.getElementById(bubbleId);
        if(el) bindSwipe(el, msg);
      }, 0);
    });

    setTimeout(() => { box.scrollTop = box.scrollHeight; }, 50);
  }

  // --- SIMPAN & POLLING ---
  function simpanPesan(chatId, nama, text, sender, msgId, type, mediaUrl='', replyText=null, chatType='private', realSender=null) {
    chatId = chatId?.toString?.() || String(chatId);
    nama = safeName(nama, chatId);

    if (!chatsData[chatId]) chatsData[chatId] = { id: chatId, name: nama, type: chatType, unread: 0, avatar: '', messages: [] };
    else {
      chatsData[chatId].name = nama;
      chatsData[chatId].type = chatType || chatsData[chatId].type;
    }

    if (sender === 'user' && activeChatId !== chatId) chatsData[chatId].unread = (chatsData[chatId].unread || 0) + 1;

    chatsData[chatId].messages.push({
      id: msgId,
      text,
      sender,
      type,
      mediaUrl,
      replyToText: replyText,
      realSender,
      timestamp: Date.now()
    });

    let botId = bots.find(b => b.token === activeToken)?.id;
    if(botId) localStorage.setItem(`dz_chats_${botId}`, JSON.stringify(chatsData));

    renderSidebar();
    if (activeChatId == chatId) renderMessages();

    // avatar fetch only for private-ish ids and only if we don't already have it
    if(sender === 'user' && !chatsData[chatId].avatar) {
      tgApi('getUserProfilePhotos', { user_id: chatId, limit: 1 }).then(async res => {
        if (res.ok && res.result.total_count > 0) {
          let fRes = await tgApi('getFile', { file_id: res.result.photos[0][0].file_id });
          if(fRes.ok) {
            chatsData[chatId].avatar = `https://api.telegram.org/file/bot${activeToken}/${fRes.result.file_path}`;
            if(botId) localStorage.setItem(`dz_chats_${botId}`, JSON.stringify(chatsData));
            renderSidebar();
          }
        }
      });
    }
  }

  function startPolling() {
    if(pollingInterval) clearInterval(pollingInterval);
    let botId = bots.find(b => b.token === activeToken)?.id;
    if(!botId) return;

    let offsetKey = `offset_${botId}`;
    let localOffset = parseInt(localStorage.getItem(offsetKey)) || 0;

    pollingInterval = setInterval(async () => {
      let res = await tgApi('getUpdates', { offset: localOffset + 1 });
      if (res.ok && res.result.length > 0) {
        for (let update of res.result) {
          localOffset = update.update_id;
          localStorage.setItem(offsetKey, localOffset);

          if (update.message) {
            let msg = update.message;
            let type = 'text';
            let mediaUrl = '';
            let teks = msg.text || msg.caption || '';

            const chatType = safeName(msg.chat?.type,'private');
            const chatName = chatType === 'private'
              ? safeName(msg.from?.first_name || msg.from?.username, 'User')
              : safeName(msg.chat?.title, 'Grup');

            let fileId = null;
            if (msg.photo) { type = 'photo'; fileId = msg.photo[msg.photo.length - 1].file_id; }
            else if (msg.video || (msg.document && msg.document.mime_type?.startsWith('video/'))) { type = 'video'; fileId = msg.video ? msg.video.file_id : msg.document.file_id; }
            else if (msg.audio || msg.voice) { type = 'audio'; fileId = msg.audio ? msg.audio.file_id : msg.voice.file_id; }
            else if (msg.sticker) { type = 'sticker'; fileId = msg.sticker.file_id; teks = msg.sticker.emoji || 'Stiker'; }

            if(fileId) {
              let fRes = await tgApi('getFile', {file_id: fileId});
              if(fRes.ok) mediaUrl = `https://api.telegram.org/file/bot${activeToken}/${fRes.result.file_path}`;
            }

            let replyTxt = msg.reply_to_message ? (msg.reply_to_message.text || msg.reply_to_message.caption || 'Media') : null;
            let realSender = safeName(msg.from?.first_name || msg.from?.username, 'User');

            simpanPesan(
              msg.chat.id.toString(),
              chatName,
              teks,
              'user',
              msg.message_id,
              type,
              mediaUrl,
              replyTxt,
              chatType,
              realSender
            );
          }
        }
      }
    }, 2000);
  }

  // --- KIRIM ---
  async function handleFileUpload() {
    let f = document.getElementById('fileUpload').files[0];
    if (!f || !activeChatId) return;

    let isVid = f.type.startsWith('video/');
    let isAud = f.type.startsWith('audio/');
    let method = isVid ? 'sendVideo' : (isAud ? 'sendAudio' : 'sendPhoto');
    let param = isVid ? 'video' : (isAud ? 'audio' : 'photo');

    let fd = new FormData();
    fd.append('chat_id', activeChatId);
    fd.append(param, f);
    if(replyToMsgId) fd.append('reply_to_message_id', replyToMsgId);

    showToast('Mengirim file...');
    let res = await tgApi(method, fd, true);
    if(res.ok) {
      simpanPesan(activeChatId, chatsData[activeChatId].name, '', 'bot', res.result.message_id, isVid?'video':(isAud?'audio':'photo'), URL.createObjectURL(f), null);
      cancelAction();
    } else showToast('Gagal ngirim file', 'error');
  }

  async function kirimPesan() {
    if (!activeChatId) return showToast('Pilih obrolan dulu!', 'error');

    let text = document.getElementById('msgInput').value.trim();
    if (!text) return;

    if(editMsgId) {
      let res = await tgApi('editMessageText', {chat_id: activeChatId, message_id: editMsgId, text: text, parse_mode: 'HTML'});
      if(res.ok) {
        let msgIdx = chatsData[activeChatId].messages.findIndex(m => m.id === editMsgId);
        if(msgIdx > -1) chatsData[activeChatId].messages[msgIdx].text = text;
        let botId = bots.find(b => b.token === activeToken).id;
        localStorage.setItem(`dz_chats_${botId}`, JSON.stringify(chatsData));
        renderMessages();
        cancelAction();
        showToast('Pesan diedit!');
      } else showToast('Gagal edit pesan', 'error');
      return;
    }

    document.getElementById('msgInput').value = '';
    document.getElementById('msgInput').style.height='';

    let payload = { chat_id: activeChatId, text: text, parse_mode: 'HTML' };
    if(replyToMsgId) payload.reply_to_message_id = replyToMsgId;

    let res = await tgApi('sendMessage', payload);
    if (res.ok) {
      simpanPesan(activeChatId, chatsData[activeChatId].name, text, 'bot', res.result.message_id, 'text', '', replyToMsgId ? document.getElementById('action-text-ui').innerText : null);
      cancelAction();
    } else showToast('Gagal ngirim', 'error');
  }
</script>

</body>
</html>
